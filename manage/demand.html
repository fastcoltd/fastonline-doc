<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FASTRESP - 需求信息</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/antd/4.24.14/antd.min.css" />
    <link rel="stylesheet" href="_style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.43/moment-timezone-with-data.min.js"></script>
    <script src="https://www.w3schools.com/lib/w3.js"></script>
    <script src="_common.js"></script>
    <script src="_opt.js"></script>
    <style>
        .col-checkbox { width: 5%; min-width: 50px; }
        .col-id { width: 8%; min-width: 60px; }
        .col-user-id { width: 10%; min-width: 80px; }
        .col-brand-id { width: 10%; min-width: 80px; }
        .col-services-id { width: 10%; min-width: 80px; }
        .col-status { width: 8%; min-width: 60px; }
        .col-language { width: 8%; min-width: 60px; }
        .col-demand-name { width: 12%; min-width: 100px; }
        .col-price-from { width: 10%; min-width: 80px; }
        .col-price-to { width: 10%; min-width: 80px; }
        .col-quantity { width: 8%; min-width: 60px; }
        .col-create-time { width: 12%; min-width: 100px; }
        .col-actions { width: 18%; min-width: 100px; }
    </style>
</head>
<body>
<div class="container">
    <div id="header" w3-include-html="_header.html"></div>
    <div class="content-wrapper">
        <div id="sidebar" w3-include-html="_sidebar.html"></div>
        <div class="main-content">
            <div class="tabs-container">
                <div class="ant-tabs ant-tabs-top">
                    <div class="ant-tabs-nav" role="tablist">
                        <div class="ant-tabs-nav-wrap">
                            <div class="ant-tabs-nav-list">
                                <div class="ant-tabs-tab ant-tabs-tab-active" onclick="switchTab('demand.html')">
                                    <span class="ant-tabs-tab-btn">需求信息</span>
                                    <div class="ant-tabs-ink-bar ant-tabs-ink-bar-animated" style="left: 0; width: 100%;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="ant-tabs-content-holder">
                        <div class="ant-tabs-content ant-tabs-content-top">
                            <div class="ant-tabs-tabpane ant-tabs-tabpane-active">
                                <div class="filter-container"></div>
                                <div class="action-container"></div>
                                <div class="task-list">
                                    <div class="table-header"></div>
                                    <div id="demand-list">加载中...</div>
                                    <div class="pagination"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="footer" w3-include-html="_footer.html"></div>
    <!-- 审核弹窗 -->
    <div id="reviewModal" class="modal">
        <div class="modal-content" style="width: 80%; max-height: 90vh; overflow-y: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
            <button class="close-btn" onclick="closeReviewModal()">×</button>
            <h3 id="reviewModalTitle">审核需求信息</h3>
            <div class="review-comparison" style="padding: 16px;">
                <h4 style="margin-bottom: 12px; color: #333;">版本对比</h4>
                <div style="display: flex; background: #fafafa; padding: 8px; border-bottom: 1px solid #ddd; font-weight: bold;">
                    <div style="width: 15%;">字段</div>
                    <div style="flex: 1;">线上版本</div>
                    <div style="flex: 1;">审核版本</div>
                    <div style="width: 10%; text-align: center;">操作</div>
                </div>
                <div id="comparisonContent" style="border: 1px solid #eee; border-top: none; background: #fff;"></div>
            </div>
            <div class="review-action" style="padding: 16px; border-top: 1px solid #eee;">
                <h4 style="margin-bottom: 12px; color: #333;">审核操作</h4>
                <div style="margin-bottom: 16px;">
                    <label style="font-weight: bold;">状态:</label>
                    <select id="reviewStatus" class="ant-select" style="width: 200px; margin-left: 8px;">
                        <option value="1">通过审核</option>
                        <option value="2">已拒绝</option>
                    </select>
                </div>
                <div id="reviewReply" style="display: none; margin-bottom: 16px;">
                    <label style="font-weight: bold;">站点回复:</label>
                    <textarea id="reviewSiteReply" class="ant-input" rows="4" style="width: 100%; margin-top: 8px;"></textarea>
                </div>
                <div style="text-align: right;">
                    <button class="ant-btn ant-btn-blue" onclick="closeReviewModal()" style="margin-right: 8px;">取消</button>
                    <button class="ant-btn ant-btn-primary" onclick="submitReview()">审核</button>
                </div>
            </div>
        </div>
    </div>
    <!-- 预览弹窗 -->
    <div id="previewModal" class="modal"></div>
</div>

<script>
    function getRandomItem(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
    }
    function randomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function randomDecimal(min, max, precision) {
        return parseFloat((Math.random() * (max - min) + min).toFixed(precision));
    }

    // 模拟用户、品牌、服务、店铺名称
    const userNames = ['张三', '李四', '王五', '赵六', '钱七'];
    const brandNames = ['Nike', 'Adidas', 'Apple', 'Samsung', 'Sony'];
    const serviceNames = ['技术支持', '物流服务', '客户咨询', '售后维修', '支付支持'];
    const storeNames = ['时尚服饰店', '电子产品店', '美食天地', '家居生活馆', '运动装备店'];
    let i = 0
    const statusList = [
        {value: i++, label: '待审核'},
        {value: i++, label: '通过审核'},
        {value: i++, label: '已拒绝'},
        {value: i++, label: '已交定金'},
        {value: i++, label: '暂未开始'},
        {value: i++, label: '竞标中'},
        {value: i++, label: '已中标'},
        {value: i++, label: '已付尾款'},
        {value: i++, label: '已交付'},
        {value: i++, label: '需求完成'},
        {value: i++, label: '评价完成'},
        {value: i++, label: '需求过期'},
        {value: i++, label: '已退款'},
        {value: i++, label: '客户关闭'},
        {value: i++, label: '已废弃'}
    ];

    function getStatusMap(){
        let statusMap = {};
        statusList.forEach(i =>{
            statusMap[i.value] = i.label
        })
        return statusMap
    }

    // 多语言样本数据
    const demandData = {
        'zh_CN': {
            names: ['运动鞋需求', '手机配件需求', '美食配送需求', '家具定制需求', '电子产品需求'],
            info: ['需要高质量的运动鞋，数量1000双。', '手机配件需支持最新型号。', '美食配送需当日到达。', '家具需定制尺寸和颜色。', '电子产品需保修两年。']
        },
        'en_US': {
            names: ['Sports Shoes Demand', 'Phone Accessories Demand', 'Food Delivery Demand', 'Furniture Customization Demand', 'Electronics Demand'],
            info: ['Need high-quality sports shoes, 1000 pairs.', 'Phone accessories for latest models.', 'Food delivery same-day.', 'Furniture with custom size and color.', 'Electronics with 2-year warranty.']
        },
        'fr_FR': {
            names: ['Demande de chaussures de sport', 'Demande d’accessoires téléphoniques', 'Demande de livraison de nourriture', 'Demande de personnalisation de meubles', 'Demande d’électronique'],
            info: ['Besoin de chaussures de sport de haute qualité, 1000 paires.', 'Accessoires pour les derniers modèles de téléphones.', 'Livraison de nourriture le jour même.', 'Meubles avec taille et couleur personnalisées.', 'Électronique avec garantie de 2 ans.']
        },
        'es_ES': {
            names: ['Demanda de zapatillas deportivas', 'Demanda de accesorios telefónicos', 'Demanda de entrega de comida', 'Demanda de personalización de muebles', 'Demanda de electrónica'],
            info: ['Necesitamos zapatillas deportivas de alta calidad, 1000 pares.', 'Accesorios para los últimos modelos de teléfonos.', 'Entrega de comida el mismo día.', 'Muebles con tamaño y color personalizados.', 'Electrónica con garantía de 2 años.']
        },
        'vi_VN': {
            names: ['Nhu cầu giày thể thao', 'Nhu cầu phụ kiện điện thoại', 'Nhu cầu giao đồ ăn', 'Nhu cầu tùy chỉnh nội thất', 'Nhu cầu điện tử'],
            info: ['Cần giày thể thao chất lượng cao, 1000 đôi.', 'Phụ kiện cho các mẫu điện thoại mới nhất.', 'Giao đồ ăn trong ngày.', 'Nội thất tùy chỉnh kích thước và màu sắc.', 'Điện tử có bảo hành 2 năm.']
        },
        'ru_RU': {
            names: ['Спрос на спортивную обувь', 'Спрос на аксессуары для телефонов', 'Спрос на доставку еды', 'Спрос на кастомизацию мебели', 'Спрос на электронику'],
            info: ['Нужна качественная спортивная обувь, 1000 пар.', 'Аксессуары для последних моделей телефонов.', 'Доставка еды в тот же день.', 'Мебель с индивидуальными размерами и цветом.', 'Электроника с гарантией 2 года.']
        }
    };

    window.tableConfig = {
        tableName: 'demand',
        tableTitle: '需求信息',
        sampleCount: 200,
        defaultPerPage: 20,
        fields: [
            // 主表字段
            { name: 'id', isSystemField: true, generator: id => id },
            { name: 'status', generator: () => randomInt(0, statusList.length - 1) },
            { name: 'user_id', generator: () => randomInt(1, 50) },
            { name: 'brand_id', generator: () => randomInt(1, 20) },
            { name: 'services_id', generator: () => randomInt(1, 30) },
            { name: 'price_from', generator: () => randomDecimal(10, 500, 2) },
            { name: 'price_to', generator: () => randomDecimal(50, 1000, 2) },
            { name: 'quantity', generator: () => randomInt(1, 1000) },
            { name: 'deposit', generator: () => randomDecimal(0, 200, 2) },
            { name: 'samples_need', generator: () => randomInt(0, 1) },
            { name: 'after_sales_time', generator: () => randomInt(30, 365) },
            { name: 'start_time', generator: () => moment().subtract(randomInt(30, 180), 'days').unix() },
            { name: 'end_time', generator: () => moment().add(randomInt(30, 180), 'days').unix() },
            { name: 'paid_rest_money', generator: () => randomInt(0, 1) ? randomDecimal(0, 800, 2) : 0 },
            { name: 'paid_time', isSystemField: true, generator: () => randomInt(0, 1) ? moment().subtract(randomInt(1, 90), 'days').unix() : 0 },
            { name: 'choose_store_id', generator: () => randomInt(0, 1) ? randomInt(1, 15) : 0 },
            { name: 'choose_unit_price', generator: () => randomInt(0, 1) ? randomDecimal(10, 900, 2) : 0 },
            { name: 'choose_time', isSystemField: true, generator: () => randomInt(0, 1) ? moment().subtract(randomInt(1, 60), 'days').unix() : 0 },
            { name: 'amount', generator: () => randomInt(0, 1) ? randomDecimal(50, 1000, 2) : 0 },
            { name: 'create_time', isSystemField: true, generator: () => moment().subtract(randomInt(1, 365), 'days').unix() },
            { name: 'confirm_time', isSystemField: true, generator: () => randomInt(0, 1) ? moment().subtract(randomInt(1, 300), 'days').unix() : 0 },
            // 多语言表字段
            { name: 'id', isLangField: true, isSystemField: true, generator: id => id * 6 + randomInt(1, 6) },
            { name: 'demand_id', isLangField: true, generator: id => id },
            { name: 'language', isLangField: true, generator: (id, lang) => lang },
            { name: 'version', isLangField: true, generator: () => randomInt(1, 5) },
            { name: 'seo_keywords', isLangField: true, generator: (id, lang) => `${demandData[lang].names[id % 5]}, Demand ${id}` },
            { name: 'seo_description', isLangField: true, generator: (id, lang) => `Details about ${demandData[lang].names[id % 5]}` },
            { name: 'after_sales_rules', isLangField: true, generator: (id, lang) => `售后规则 #${id}: 退货需在30天内。` },
            { name: 'demand_name', isLangField: true, generator: (id, lang) => `${demandData[lang].names[id % 5]} #${id}` },
            { name: 'demand_information', isLangField: true, generator: (id, lang) => `${demandData[lang].info[id % 5]} (ID: ${id})` },
            { name: 'site_reply', isLangField: true, generator: id => randomInt(0, 1) ? `回复 #${id}: 已处理` : '' }
        ],
        actionButtons: [
            { label: '添加', className: 'ant-btn ant-btn-primary', action: 'addRecord' },
            { label: '批量删除', className: 'ant-btn ant-btn-danger', action: 'batchDelete' },
            { label: '批量修改状态', className: 'ant-btn ant-btn-default', color: '#fa8c16', field: { name: 'status', label: '状态', type: 'select', options: statusList } },
            { label: '批量修改用户', className: 'ant-btn ant-btn-default', color: '#1890ff', field: { name: 'user_id', label: '用户', type: 'select', options: () => Array.from({ length: 15 }, (_, i) => ({ value: i + 1, label: `${userNames[i % userNames.length]} ${i + 1}` })) } },
            { label: '批量修改品牌', className: 'ant-btn ant-btn-default', color: '#52c41a', field: { name: 'brand_id', label: '品牌', type: 'select', options: () => Array.from({ length: 15 }, (_, i) => ({ value: i + 1, label: `${brandNames[i % brandNames.length]} ${i + 1}` })) } },
            { label: '批量修改服务', className: 'ant-btn ant-btn-default', color: '#722ed1', field: { name: 'services_id', label: '服务', type: 'select', options: () => Array.from({ length: 15 }, (_, i) => ({ value: i + 1, label: `${serviceNames[i % serviceNames.length]} ${i + 1}` })) } },
            { label: '批量修改选择店铺', className: 'ant-btn ant-btn-default', color: '#eb2f96', field: { name: 'choose_store_id', label: '选择店铺', type: 'select', options: () => Array.from({ length: 15 }, (_, i) => ({ value: i + 1, label: `${storeNames[i % storeNames.length]} ${i + 1}` })) } }
        ],
        listFields: [
            { name: 'id', label: 'ID', className: 'col-id' },
            { name: 'user_id', label: '用户', className: 'col-user-id', formatter: v => `${userNames[v % userNames.length]} (${v})` },
            { name: 'brand_id', label: '品牌', className: 'col-brand-id', formatter: v => `${brandNames[v % brandNames.length]} (${v})` },
            { name: 'services_id', label: '服务', className: 'col-services-id', formatter: v => `${serviceNames[v % serviceNames.length]} (${v})` },
            { name: 'status', label: '状态', className: 'col-status', formatter: v => {
                    const statusMap = getStatusMap();
                    const colorMap = { 0: 'orange', 1: 'green', 2: 'red', 3: 'blue', 4: 'purple', 5: 'green', 6: 'gray', 7: 'gray', 8: 'red' };
                    return `<span class="ant-tag ant-tag-${colorMap[v]}">${statusMap[v]}</span>`;
                }},
            { name: 'language', label: '语言', className: 'col-language', isLangField: true },
            { name: 'demand_name', label: '需求名称', className: 'col-demand-name', isLangField: true },
            { name: 'price_from', label: '价格下限', className: 'col-price-from' },
            { name: 'price_to', label: '价格上限', className: 'col-price-to' },
            { name: 'quantity', label: '数量', className: 'col-quantity' },
            { name: 'create_time', label: '创建时间', className: 'col-create-time', formatter: v => moment.unix(v).format('YYYY-MM-DD HH:mm:ss') },
            {
                name: 'actions',
                label: '操作',
                className: 'col-actions',
                formatter: (_, item) => `
                    <button class="ant-btn ant-btn-primary" onclick="window.location.href='demand_bid.html'" style="margin-right: 8px;">竞标者</button>
                    <button class="ant-btn" onclick="editRecord(${item.id})" style="margin-right: 8px;">编辑</button>
                    ${item.status === 0 ? `<button class="ant-btn ant-btn-primary" onclick="showReviewModal(${item.id})">审核</button>` : `<button class="ant-btn ant-btn-danger" onclick="deleteRecord(${item.id})">删除</button>`}
                `
            }
        ],
        filterFields: [
            { id: 'user_id', type: 'select', options: () => Array.from({ length: 15 }, (_, i) => ({ value: i + 1, label: `${userNames[i % userNames.length]} ${i + 1}` })), filter: (data, value) => value === '' ? data : data.filter(d => d.user_id === parseInt(value)) },
            { id: 'brand_id', type: 'select', options: () => Array.from({ length: 15 }, (_, i) => ({ value: i + 1, label: `${brandNames[i % brandNames.length]} ${i + 1}` })), filter: (data, value) => value === '' ? data : data.filter(d => d.brand_id === parseInt(value)) },
            { id: 'services_id', type: 'select', options: () => Array.from({ length: 15 }, (_, i) => ({ value: i + 1, label: `${serviceNames[i % serviceNames.length]} ${i + 1}` })), filter: (data, value) => value === '' ? data : data.filter(d => d.services_id === parseInt(value)) },
            { id: 'choose_store_id', type: 'select', options: () => Array.from({ length: 15 }, (_, i) => ({ value: i + 1, label: `${storeNames[i % storeNames.length]} ${i + 1}` })), filter: (data, value) => value === '' ? data : data.filter(d => d.choose_store_id === parseInt(value)) },
            { id: 'status', type: 'select', options: statusList, filter: (data, value) => value === '' ? data : data.filter(d => d.status === parseInt(value)) },
            { id: 'language', type: 'select', options: [{ value: '', label: '全部语言' }, { value: 'zh_CN', label: '中文' }, { value: 'en_US', label: '英语' }, { value: 'fr_FR', label: '法语' }, { value: 'es_ES', label: '西班牙语' }, { value: 'vi_VN', label: '越南语' }, { value: 'ru_RU', label: '俄语' }], filter: (data, value) => value ? data.filter(d => tableLangData.some(l => l.demand_id === d.id && l.language === value)) : data },
            { id: 'demand_name', type: 'text', placeholder: '搜索需求名称', filter: (data, value) => value ? data.filter(d => tableLangData.some(l => l.demand_id === d.id && l.demand_name.toLowerCase().includes(value.toLowerCase()))) : data },
            { id: 'startDate', type: 'date', filter: (data, value) => value ? data.filter(d => moment.unix(d.create_time).isSameOrAfter(value)) : data },
            { id: 'endDate', type: 'date', filter: (data, value) => value ? data.filter(d => moment.unix(d.create_time).isSameOrBefore(value)) : data }
        ],
        langFields: {
            foreignKey: 'demand_id',
            languages: ['zh_CN', 'en_US', 'fr_FR', 'es_ES', 'vi_VN', 'ru_RU']
        },
        modalTabs: [
            {
                id: 'basic',
                title: '基本信息',
                fields: [
                    { name: 'user_id', label: '用户', type: 'select', options: () => Array.from({ length: 15 }, (_, i) => ({ value: i + 1, label: `${userNames[i % userNames.length]} ${i + 1}` })), showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'brand_id', label: '品牌', type: 'select', options: () => Array.from({ length: 15 }, (_, i) => ({ value: i + 1, label: `${brandNames[i % brandNames.length]} ${i + 1}` })), showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'services_id', label: '服务', type: 'select', options: () => Array.from({ length: 15 }, (_, i) => ({ value: i + 1, label: `${serviceNames[i % serviceNames.length]} ${i + 1}` })), showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'status', label: '状态', type: 'select', options: statusList, showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'price_from', label: '价格下限', type: 'number', showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'price_to', label: '价格上限', type: 'number', showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'quantity', label: '数量', type: 'number', showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'deposit', label: '定金', type: 'number', showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'samples_need', label: '需要样品', type: 'select', options: [{ value: 0, label: '否' }, { value: 1, label: '是' }], showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'after_sales_time', label: '售后时间(天)', type: 'number', showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'id', label: 'ID', type: 'text', showInAdd: false, showInEdit: true, editableInAdd: false, editableInEdit: false },
                    { name: 'create_time', label: '创建时间', type: 'datetime-local', formatter: v => moment.unix(v).format('YYYY-MM-DDTHH:mm'), showInAdd: false, showInEdit: true, editableInAdd: false, editableInEdit: false }
                ]
            },
            {
                id: 'details',
                title: '详细信息',
                fields: [
                    { name: 'start_time', label: '开始时间', type: 'datetime-local', formatter: v => moment.unix(v).format('YYYY-MM-DDTHH:mm'), showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'end_time', label: '结束时间', type: 'datetime-local', formatter: v => moment.unix(v).format('YYYY-MM-DDTHH:mm'), showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'paid_rest_money', label: '已付余款', type: 'number', showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'paid_time', label: '支付时间', type: 'datetime-local', formatter: v => v ? moment.unix(v).format('YYYY-MM-DDTHH:mm') : '', showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'choose_store_id', label: '选择店铺', type: 'select', options: () => Array.from({ length: 15 }, (_, i) => ({ value: i + 1, label: `${storeNames[i % storeNames.length]} ${i + 1}` })), showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'choose_unit_price', label: '选择单价', type: 'number', showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'choose_time', label: '选择时间', type: 'datetime-local', formatter: v => v ? moment.unix(v).format('YYYY-MM-DDTHH:mm') : '', showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'amount', label: '总金额', type: 'number', showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'confirm_time', label: '确认时间', type: 'datetime-local', formatter: v => v ? moment.unix(v).format('YYYY-MM-DDTHH:mm') : '', showInAdd: false, showInEdit: true, editableInAdd: false, editableInEdit: false }
                ]
            },
            {
                id: 'lang',
                title: '多语言信息',
                fields: [
                    { name: 'language', label: '语言', type: 'select', options: ['zh_CN', 'en_US', 'fr_FR', 'es_ES', 'vi_VN', 'ru_RU'].map(l => ({ value: l, label: l })), showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: false },
                    { name: 'version', label: '版本', type: 'number', isLangField: true, showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'seo_keywords', label: 'SEO关键词', type: 'text', isLangField: true, showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'seo_description', label: 'SEO描述', type: 'text', isLangField: true, showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'after_sales_rules', label: '售后规则', type: 'textarea', isLangField: true, showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'demand_name', label: '需求名称', type: 'text', isLangField: true, showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'demand_information', label: '需求信息', type: 'textarea', isLangField: true, showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true },
                    { name: 'site_reply', label: '站点回复', type: 'textarea', isLangField: true, showInAdd: true, showInEdit: true, editableInAdd: true, editableInEdit: true }
                ]
            }
        ]
    };

    // 支持 Enter 键触发查询
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && document.activeElement.tagName === 'INPUT') {
            applyFilters();
        }
    });

    // 显示审核弹窗
    let currentReviewId = null;
    function showReviewModal(id) {
        const demand = tableData.find(item => item.id === id);
        if (!demand) return;

        currentReviewId = id;
        document.getElementById('reviewModalTitle').textContent = `审核需求信息 (ID: ${id})`;
        const modal = document.getElementById('reviewModal');
        const comparisonContent = document.getElementById('comparisonContent');

        // 获取当前语言版本（以 zh_CN 为例）
        const currentLang = tableLangData.find(lang => lang.demand_id === id && lang.language === 'zh_CN') || {};

        // 查找线上版本（状态为“通过审核”的最高版本）
        const onlineLang = tableLangData
            .filter(lang => lang.demand_id === id && tableData.find(d => d.id === lang.demand_id).status === 1)
            .sort((a, b) => b.version - a.version)[0] || null;

        // 定义对比字段
        const reviewFields = [
            { name: 'user_id', label: '用户', formatter: v => `${userNames[v % userNames.length]} (${v})` },
            { name: 'brand_id', label: '品牌', formatter: v => `${brandNames[v % brandNames.length]} (${v})` },
            { name: 'services_id', label: '服务', formatter: v => `${serviceNames[v % serviceNames.length]} (${v})` },
            { name: 'price_from', label: '价格下限', formatter: v => new Number(v).toFixed(2) },
            { name: 'price_to', label: '价格上限', formatter: v => new Number(v).toFixed(2) },
            { name: 'deposit', label: '定金', formatter: v => new Number(v).toFixed(2) },
            { name: 'samples_need', label: '需要样品', formatter: v => v == 1 ? "需要" : "无需" },
            { name: 'quantity', label: '数量' },
            { name: 'version', label: '版本' },
            { name: 'demand_name', label: '需求名称', isLangField: true },
            { name: 'demand_information', label: '需求信息', isLangField: true },
            { name: 'seo_keywords', label: 'SEO关键词', isLangField: true },
            { name: 'seo_description', label: 'SEO描述', isLangField: true }
        ];

        const comparisonHTML = reviewFields.map(field => {
            const onlineValue = onlineLang ? (field.isLangField ? onlineLang[field.name] : demand[field.name]) || 'N/A' : '初次提交';
            const currentValue = field.isLangField ? currentLang[field.name] || 'N/A' : demand[field.name] || 'N/A';
            const formattedOnline = field.formatter ? field.formatter(onlineValue) : onlineValue;
            const formattedCurrent = field.formatter ? field.formatter(currentValue) : currentValue;
            const isDifferent = formattedOnline !== formattedCurrent;

            return `
                <div style="display: flex; padding: 12px; border-bottom: 1px solid #eee; align-items: center; ${isDifferent ? 'background: #fff7e6;' : ''}">
                    <div style="width: 15%; padding-right: 12px; font-weight: bold; color: #555;">${field.label}</div>
                    <div style="flex: 1; padding-right: 12px;">${formattedOnline}</div>
                    <div style="flex: 1; padding-right: 12px; ${isDifferent ? 'color: red;' : 'color: green;'}">${formattedCurrent}</div>
                    <div style="width: 10%; text-align: center;">
                        <button class="ant-btn ant-btn-link" style="${isDifferent ? 'color: red;' : 'color: green;'}" onclick="showPreviewModal('${field.name}', '${escapeHtml(String(formattedOnline))}', '${escapeHtml(String(formattedCurrent))}', false)">对比</button>
                    </div>
                </div>
            `;
        }).join('');

        comparisonContent.innerHTML = comparisonHTML;
        document.getElementById('reviewStatus').value = '1';
        document.getElementById('reviewSiteReply').value = '';
        document.getElementById('reviewReply').style.display = 'none';
        modal.style.display = 'block';

        document.getElementById('reviewStatus').addEventListener('change', (e) => {
            document.getElementById('reviewReply').style.display = e.target.value === '2' ? 'block' : 'none';
        });
    }

    // 关闭审核弹窗
    function closeReviewModal() {
        const modal = document.getElementById('reviewModal');
        if (modal) modal.style.display = 'none';
    }

    // 提交审核
    function submitReview() {
        const status = parseInt(document.getElementById('reviewStatus').value);
        const siteReply = document.getElementById('reviewSiteReply').value || '';
        const demand = tableData.find(item => item.id === currentReviewId);
        const langEntry = tableLangData.find(lang => lang.demand_id === currentReviewId && lang.language === 'zh_CN');

        if (demand && langEntry) {
            if (status === 2 && !siteReply) {
                alert('请填写拒绝原因');
                return;
            }

            demand.status = status;
            if (status === 2 && siteReply) {
                langEntry.site_reply = siteReply; // 拒绝时保存回复
            }
            langEntry.update_time = moment().unix();
        }

        closeReviewModal();
        renderTable();
    }

    // 显示预览弹窗
    function showPreviewModal(fieldName, oldValue, newValue, isImageField = false) {
        const modal = document.getElementById('previewModal');
        const contentHeight = Math.min(Math.max(oldValue.length, newValue.length) * 20, window.innerHeight * 0.8);
        let oldDisplay = unescapeHtml(oldValue);
        let newDisplay = unescapeHtml(newValue);

        modal.innerHTML = `
            <div class="modal-content" style="width: 70%; height: ${contentHeight}px; min-height: 20vh; max-height: 80vh; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <button class="close-btn" onclick="closePreviewModal()">×</button>
                <h3 style="padding: 16px; border-bottom: 1px solid #eee; margin: 0;">${fieldName} 预览</h3>
                <div style="display: flex; height: calc(100% - 40px);">
                    <div style="flex: 1; padding: 12px; overflow-y: auto; border-right: 1px solid #ddd; background: #fafafa;">
                        <strong style="color: #555;">旧版本:</strong>
                        <div style="margin-top: 8px;">${oldDisplay}</div>
                    </div>
                    <div style="flex: 1; padding: 12px; overflow-y: auto; background: #fff;">
                        <strong style="color: #555;">新版本:</strong>
                        <div style="margin-top: 8px;">${newDisplay}</div>
                    </div>
                </div>
            </div>
        `;
        modal.style.display = 'block';
    }

    // 关闭预览弹窗
    function closePreviewModal() {
        const modal = document.getElementById('previewModal');
        if (modal) modal.style.display = 'none';
    }

    // HTML 转义和反转义
    function escapeHtml(text) {
        return text.replace(/&/g, '&').replace(/</g, '<').replace(/>/g, '>').replace(/"/g, '"').replace(/'/g, '\'');
    }
    function unescapeHtml(html) {
        return html.replace(/&/g, '&').replace(/</g, '<').replace(/>/g, '>').replace(/"/g, '"').replace(/'/g, "'");
    }
</script>
</body>
</html>