<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>商品详情 - FASTRESP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/antd/4.24.10/antd.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="_style.css">
    <link rel="stylesheet" href="_site.css">
    <style>
        html { overflow: auto!important; height: auto; }
        body { padding-top: 7.4em !important; height: auto; overflow: auto !important; transition: padding-top 0.3s ease; }
        .page-container { max-width: var(--max-content-width); margin: 0 auto; }

        /* 头部和导航 */
        .header { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; transition: opacity 0.3s; }
        .header.hidden { opacity: 0; height: 0; overflow: hidden; }

        /* 商品信息 + 购物功能 */
        .breadcrumb-wrapper { background: var(--bg-white); padding: 0.5em; margin: 0.5em 0;border-radius: 0.5em; }
        .breadcrumb a { color: var(--natural-green); margin-right: 0.2em; }
        .breadcrumb span { color: var(--text-secondary); }

        .item-top { display: flex; flex-direction: column; padding: 0.5em; background: var(--bg-white); border-radius: 0.5em; border-bottom: 0.0625em solid var(--border-color); position: relative; z-index: 20; }
        .item-top.fixed {
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: var(--max-content-width);
            background: var(--bg-white);
            z-index: 30;
            border-bottom: 0.0625em solid var(--border-color);
        }
        .item-top.fixed::before { /* 两边白色背景延伸 */
            content: '';
            position: absolute;
            top: 0;
            left: -100vw; /* 向左延伸 */
            right: -100vw; /* 向右延伸 */
            height: 100%;
            background: var(--bg-white);
            z-index: -1;
            border-bottom: 0.0625em solid var(--border-color);
        }
        .item-top.fixed::after { /* 下方分割线 */
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 0.0625em;
            background: var(--border-color);
            border-bottom: 0.0625em solid var(--border-color);
        }

        .item-info { flex: none; }
        .item-info-left { float: left; margin-right: 1em; }
        .item-info-left img { width: 8em; height: 8em; object-fit: cover; border-radius: 50%; }
        .item-info-right { overflow: hidden; }
        .item-info-right h1 { margin-bottom: 0em; }
        .item-info-right p { margin: 0.5em; }
        .item-wholesale { display: flex; gap: 0.5em; flex-wrap: wrap; align-items: center; }
        .wholesale-block { border: 0.0625em solid var(--border-color); border-radius: 0.375em; font-size: var(--font-small); padding: 0.5em; }
        .shopping-area { display:flex;position: absolute;right: 1em; justify-content: center;align-content: center;align-items: center; padding: 0; white-space: nowrap; gap: 1em;}
        .quantity-input { display: flex; align-items: center; justify-content:center; padding: 0.2em; margin-bottom: 0em; border: 0.0625em solid var(--border-color); border-radius: 0.375em; overflow: hidden; }
        .quantity-input p {align-items: center;  }
        .quantity-input button { border: none; background: var(--bg-light); cursor: pointer; }
        .quantity-input input { width: 5em; height: 2em; border: none; text-align: center; font-size: var(--font-medium); outline: none; }
        .quantity-input input::-webkit-outer-spin-button, .quantity-input input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .favorite-btn { position: absolute; top: 1em; right: 1em; font-size: 1.5em; cursor: pointer; }
        .favorited { color: #FF0000; }
        .favorite-count { position: absolute; top: 3.5em; right: 2em; font-size: var(--font-small); font-weight: bold; }

        /* 新增页签样式 */
        .item-tabs {
            display: none; /* 默认隐藏 */
            margin-top: 0em;
            display: flex;
            gap: 1em;
            padding-bottom: 0em;
        }
        .item-top.fixed .item-tabs {
            display: flex; /* 置顶时显示 */
        }
        .item-tab {
            cursor: pointer;
            padding: 0.5em 0.5em 0 0.5em ;
            font-size: var(--font-medium);
            color: var(--text-secondary);
        }
        .item-tab.active {
            font-weight: bold;
            color: var(--natural-green);
            border-bottom: 2px solid var(--natural-green);
        }

        /* 商品介绍 + sidebar */
        .content-section { display: flex; flex-direction: row; padding-top: 0.5em; }
        .item-content { flex: 0 0 75%; background: var(--bg-white); border-radius: 0.5em; padding-bottom: 2em;}
        .item-description, .item-faqs, .store-info, .item-reviews { padding: 1em 1em; }

        .item-sidebar {
            flex: 0 0 25%;
            right: calc((100% - var(--max-content-width)) / 2); /* 靠右对齐，与 page-container 一致 */
            width: calc(var(--max-content-width) * 0.25); /* 宽度为 page-container 的 25% */
            height: 60vh;
            border-radius: 0.5em;
            background: var(--bg-white);
            padding: 0.5em;
            border-left: 0.0625em solid var(--border-color);
            overflow-y: auto;
            scrollbar-width: none;
            z-index: 10; /* 确保高于 item-top 的 z-index: 20 */
        }
        .item-sidebar.hidden {
            display: none; /* 到达指定位置后立即隐藏 */
        }

        /* 置顶时调整 item-sidebar 的 top 值 */
        .item-top.fixed + .content-section .item-sidebar {
            top: calc(0em + var(--item-top-height, 0px)); /* 动态调整 */
        }

        /* 店铺信息 */
        .store-info { padding-top: 1em; }
        .store-content { display: flex; padding: 1em; border: 0.0625em solid var(--border-color); border-radius: 0.5em; align-items: center; gap: 1em; }
        .store-logo { position: relative; width: 5em; height: 5em; flex-shrink: 0; }
        .store-logo img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .online-dot { width: 0.5em; height: 0.5em; border-radius: 50%; position: absolute; bottom: 0; right: 0; }
        .store-details { flex: 1; display: flex; flex-direction: column; gap: 0em; }
        .store-details p { margin: 0; font-size: var(--font-medium); }

        .desc-section { margin-bottom: 1em; }
        .desc-section h3 { font-size: var(--font-medium); margin-bottom: 0.5em; font-weight: bold; }
        .attr-content { padding: 1em; border: 0.0625em solid var(--border-color); border-radius: 0.5em; }
        .attr-tags, .field-tags { display: flex; flex-wrap: wrap; gap: 0.5em; margin: 0.5em 0; }
        .sample-images { display: flex; gap: 0.5em; overflow-x: auto; scrollbar-width: none; }
        .sample-images img { width: 10em; height: 7em; object-fit: cover; cursor: pointer; border-radius: 0.5em; }
        .aftersales-rules { border: 0.0625em solid var(--border-color); border-radius: 0.5em; padding: 1em; }
        .aftersales-rules ul { list-style: disc; padding-left: 1.5em; max-height: 2em; overflow: hidden; transition: max-height 0.3s ease; }
        .aftersales-rules.expanded ul { max-height: none; }
        .faq-list, .review-list { margin-top: 1em; }
        .faq-item, .review-item { margin-bottom: 1em; padding: 1em; border: 0.0625em solid var(--border-color); border-radius: 0.5em; }
        .review-header { display: flex; justify-content: space-between; align-items: center; }
        .review-user { display: flex; align-items: center; gap: 0.5em; }
        .review-user img { width: 2em; height: 2em; border-radius: 50%; }
        .review-reply { display: none; margin: 0.5em 0; }
        .review-reply.expanded { display: block; }
        .review-store { cursor: pointer; padding-top: 1em; margin-bottom: 0; border-top: 0.0625em solid var(--border-color); }
        .rating-wrapper { display: flex; align-items: center; gap: 0.5em; }
        .show-more { text-align: center; margin-top: 1em; }
        .item-sidebar-inner { display: flex; flex-direction: column; }

        .action-area {display: flex;flex-direction: row; flex-wrap: nowrap; gap: 1em; position: absolute;top: 1em; right: 1em;}
        .action-area i {cursor: pointer; font-size:1.1em; padding: 0.5em 1em;border: 0.0625em solid var(--border-color);border-radius: 0.5em;}
        .action-area i:hover {background: var(--font-green);color: var(--font-white)}
        .action-area i:active { transform: scale(0.9); transition: transform 0.5s;}

        .stats-area { padding: 0; }
        .rating-group { display: flex; align-items: center; gap: 1em; justify-content: center; }
        .rating-bar { display: flex; align-items: center; gap: 0.5em; margin: 0.25em 0; width: 100%; }
        .rating-bar progress { height: 1.5em; width: 83%; }
        .chart-tabs { display: flex; margin-top:1em; gap: 1em; justify-content: flex-end; cursor: pointer; }
        .chart-tab.active { border-bottom: 2px solid var(--natural-green); color: var(--natural-green); }
        .chart-container { height: 15em; margin-bottom: 1em; font-weight: bold}

        /* 关联商品 */
        .similar-items { padding: 1em 0; }
        .similar-items .scroll-list { display: flex; gap: 0.5em; overflow-x: auto; scrollbar-width: none; }

        /* Popup Styles */
        .popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .popup-content { background: var(--bg-white); padding: 1.5em; border-radius: 0.5em; position: relative; width: 90%; max-width: 30em; box-shadow: 0 0.25em 0.5em rgba(0, 0, 0, 0.1); }
        .popup-close { position: absolute; top: 0.5em; right: 0.5em; font-size: 1.2em; cursor: pointer; color: var(--text-secondary); }
        .share-social { display: flex; justify-content: center; gap: 1.5em; margin-bottom: 1em; }
        .share-social i { font-size: 4em; cursor: pointer; transition: transform 0.2s; }
        .share-social i:hover { transform: scale(1.1); }
        .share-users { max-height: 10em; overflow-y: auto; padding: 0.5em; }
        .user-avatars { display: flex; flex-wrap: wrap; gap: 0.5em; }
        .user-avatars img { width: 2em; height: 2em; border-radius: 50%; object-fit: cover; }
        .user-more { cursor: pointer; color: var(--natural-green); margin-top: 0.5em; text-align: center; }
        .feedback-form { display: flex; flex-direction: column; gap: 1em; }
        .feedback-form select, .feedback-form textarea, .feedback-form input { width: 100%; padding: 0.5em; border: 0.0625em solid var(--border-color); border-radius: 0.375em; }
        .feedback-form button { padding: 0.5em 1em; background: var(--natural-green); color: white; border: none; border-radius: 0.375em; cursor: pointer; }

        /* 移动端适配 */
        @media (max-width: 48em) {
            body { padding-top: 5em; }
            .page-container { padding: 0; }
            .item-top { flex-direction: column; }
            .item-top.fixed { width: 100%; left: 0; transform: none; }
            .item-info { flex: 100%; }
            .item-info-left { float: none; margin: 0 auto 1em; text-align: center; }
            .item-info-left img { width: 100%; width: 6em; max-width: 12em; height: auto; }
            .shopping-area { align-self: stretch; }
            .content-section { flex-direction: column; }
            .item-content, .item-sidebar { flex: 100%; }
            .item-sidebar {
                position: static;
                border-left: none;
                border-top: 0.0625em solid var(--border-color);
                height: auto;
            }
            .similar-items .card { flex: 0 0 calc(50% - 0.5em); max-width: calc(50% - 0.5em); }
        }
    </style>
</head>
<body>
<div class="header" w3-include-html="_header.html"></div>
<div class="page-container">
    <div class="breadcrumb-wrapper" id="breadcrumb-wrapper">
        <div class="breadcrumb" id="breadcrumb"></div>
    </div>
    <div class="item-top" id="item-top">
        <div class="item-info">
            <div class="item-info-left" id="item-info-left"></div>
            <div class="item-info-right" id="item-info-right"></div>
        </div>
        <div class="item-tabs" id="item-tabs"></div> <!-- 新增页签容器 -->
    </div>
    <div class="content-section">
        <div class="item-content">
            <div class="item-description" id="item-description"></div>
            <div class="item-faqs" id="item-faqs"></div>
            <div class="store-info" id="store-info"></div>
            <div class="item-reviews" id="item-reviews"></div>
        </div>
        <div class="item-sidebar" id="item-sidebar" style="position:fixed;"></div>
    </div>
    <div class="similar-items" id="similar-items"></div>

    <!-- Share Popup -->
    <div id="share-popup" class="popup-overlay">
        <div class="popup-content">
            <i class="fas fa-times popup-close" onclick="closePopup('share-popup')"></i>
            <div class="share-social">
                <i class="fab fa-facebook" onclick="shareTo('facebook')"></i>
                <i class="fab fa-twitter" onclick="shareTo('twitter')"></i>
                <i class="fab fa-linkedin" onclick="shareTo('linkedin')"></i>
            </div>
            <div class="share-users">
                <div class="user-avatars" id="share-user-avatars"></div>
                <div class="user-more" id="share-user-more" onclick="expandUsers()"></div>
            </div>
        </div>
    </div>
    <!-- Feedback Popup -->
    <div id="feedback-popup" class="popup-overlay">
        <div class="popup-content">
            <i class="fas fa-times popup-close" onclick="closePopup('feedback-popup')"></i>
            <form class="feedback-form" id="feedback-form">
                <select id="complaint-type" onchange="updateFeedbackForm()">
                    <option value="">选择投诉类型</option>
                    <option value="item">商品问题</option>
                    <option value="store">店铺问题</option>
                    <option value="delivery">物流问题</option>
                </select>
                <div id="feedback-fields"></div>
                <button type="submit">提交</button>
            </form>
        </div>
    </div>
</div>
<div w3-include-html="_footer.html"></div>

<script src="https://www.w3schools.com/lib/w3.js"></script>
<script src="https://cdn.jsdelivr.net/npm/faker@5.5.3/dist/faker.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/brands.min.js"></script>
<script src="_fields.js"></script>
<script src="_data.js"></script>
<script src="_common.js"></script>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const itemName = urlParams.get('name') || 'Demo Item';
    const itemData = generateData(itemFieldConfig, 1)[0];
    const storeData = generateData(storeFieldConfig, 1)[0];
    let quantity = 1;
    let reviews = [];
    let reviewPage = 1;
    const reviewsPerPage = 5;
    let overviewChartInstance, salesChartInstance;

    function renderBreadcrumb() {
        const brand = itemData.brandName.replace(/<b[^>]*>(.*?)<\/b>/, '$1');
        const service = itemData.service.replace(/<b[^>]*>(.*?)<\/b>/, '$1');
        document.getElementById('breadcrumb').innerHTML = `
        <a href="index.html">Home</a> >
        <a href="brand.html?name=${brand}">${brand}</a> >
        <a href="item-list.html?services=${service}&brandName=${brand}">${service}</a>>
        <span style="margin-right: 0.5em">${itemName}</span>
    `;
    }

    function renderItemInfo() {
        const wholesaleData = generateData(itemWholesaleFieldConfig, randomInt(1, 5));
        const shippingType = faker.random.arrayElement(['Automatic', 'Manual']);

        const badgeCount = randomInt(0, 3);
        const selectedBadges = ecommerceBadges.Item
            .sort(() => 0.5 - Math.random())
            .slice(0, badgeCount);

        const badgesHtml = selectedBadges.map(badge => `
        <span class="badge"
              onmouseover="showBadgeTooltip(this, '${badge.description.replace(/'/g, "\\'")}', '${badge.name}')"
              onmouseout="hideBadgeTooltip(this)" style="color: ${badge.textColor};background: ${badge.backgroundColor}">
            ${badge.icon} ${badge.name}
            <span class="badge-tooltip">${badge.description}</span>
        </span>
    `).join('');

        document.getElementById('item-info-left').innerHTML = `<img src="${itemData.image}" alt="${itemName}">`;
        document.getElementById('item-info-right').innerHTML = `
        <h1>${itemName}${badgesHtml}</h1>
        <p>Price: <span style="color: red; font-weight: bold">${itemData.price}</span>
            ${itemData.original_price ? `<span style="color: #A9A9A9; text-decoration: line-through">${itemData.original_price.sample}</span>` : ''}
            库存: ${itemData.stock_quantity.sample} (${itemData.last_restock_time.sample})
            发货: <span style="color: ${shippingType === 'Automatic' ? '#32CD32' : '#4682B4'}">${shippingType}</span></p>
        ${wholesaleData.length ? `
            <div class="item-wholesale">
                批发价: ${wholesaleData.map(w => `<div class="wholesale-block"><span>${w.quantity.sample}~${w.quantity.sample + 100}</span>: <b>${w.unit_price}</b></div>`).join('')}
                <div class="shopping-area">
                    <p id="total-price" style="display: none;justify-content: center;"></p>
                    <div class="quantity-input">
                        <button class="btn-small" onclick="changeQuantity(-1)">-</button>
                        <input type="number" id="quantity" value="1" min="1" maxlength="5" onchange="updateTotal()">
                        <button class="btn-small" onclick="changeQuantity(1)">+</button>
                    </div>
                    <button class="btn-orange-solid-large" onclick="buyNow()" style="padding: 0.2em 5.4em;">购买</button>
                </div>
            </div>` : ''}

            <div class="action-area">
                <i class="fas fa-heart" onclick="toggleFavorite(this)"></i>
                <i class="fas fa-share-alt" onclick="renderSharePopup()"></i>
                <i class="fas fa-ellipsis-h" onclick="renderFeedbackPopup()"></i>
            </div>
    `;
    }

    function toggleFavorite(element) {
        element.classList.toggle('favorited');
    }
    // 新增：渲染分享弹窗
    function renderSharePopup() {
        const USERS_PER_ROW = 10; // 定义在函数内部，与 reviewsPerPage 一致
        let userAvatars = []; // 定义在函数内部

        const popup = document.getElementById('share-popup');
        if (!popup) return;

        const avatarsContainer = document.getElementById('share-user-avatars');
        const moreContainer = document.getElementById('share-user-more');

        const userCount = randomInt(10, 30);
        userAvatars = Array(userCount).fill().map((_, i) => getPicsumImage(50, 50, `share-user-${i}`));

        avatarsContainer.innerHTML = userAvatars.slice(0, USERS_PER_ROW)
            .map(src => `<img src="${src}" alt="User">`).join('');

        if (userCount > USERS_PER_ROW) {
            moreContainer.innerHTML = `+${userCount - USERS_PER_ROW}`;
            moreContainer.style.display = 'block';
            moreContainer.onclick = () => expandShareUsers(userAvatars, avatarsContainer, moreContainer);
        } else {
            moreContainer.style.display = 'none';
        }

        popup.style.display = 'flex';
    }

    // 新增：展开分享用户
    function expandShareUsers(userAvatars, avatarsContainer, moreContainer) {
        avatarsContainer.innerHTML = userAvatars
            .map(src => `<img src="${src}" alt="User">`).join('');
        moreContainer.style.display = 'none';
    }

    // 新增：分享到社交平台
    function shareToSocial(platform) {
        const url = encodeURIComponent(window.location.href);
        const title = encodeURIComponent(itemName);
        let shareUrl;

        switch(platform) {
            case 'facebook':
                shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${url}`;
                break;
            case 'twitter':
                shareUrl = `https://twitter.com/intent/tweet?url=${url}&text=${title}`;
                break;
            case 'linkedin':
                shareUrl = `https://www.linkedin.com/shareArticle?mini=true&url=${url}&title=${title}`;
                break;
        }

        window.open(shareUrl, '_blank', 'width=600,height=400');
    }

    // 新增：渲染反馈弹窗
    function renderFeedbackPopup() {
        const popup = document.getElementById('feedback-popup');
        if (!popup) return;

        popup.style.display = 'flex';
        updateFeedbackForm(); // 直接调用更新表单
    }

    // 新增：更新反馈表单
    function updateFeedbackForm() {
        const type = document.getElementById('complaint-type').value;
        const fieldsContainer = document.getElementById('feedback-fields');
        fieldsContainer.innerHTML = `
            <textarea placeholder="投诉内容" name="complaint_content" required rows="4"></textarea>
            <p></p>
            <p>
                Complaint Infomation
            </p>
            <p><label>items: <b>${itemName}</b></label><br/><label>Store: <b>${storeData.name}</b></label></p>
        `;
    }

    // 新增：关闭弹窗
    function closePopup(popupId) {
        const popup = document.getElementById(popupId);
        if (popup) popup.style.display = 'none';
    }

    function renderItemDescription() {
        const tags = generateTag(1, 3);
        const attrs = generateAttr(3, 5);
        const fields = fieldsList.sort(() => 0.5 - Math.random()).slice(0, randomInt(3, 10));
        const samplePics = Array(randomInt(2, 5)).fill().map((_, i) => getPicsumImage(300, 200, `sample-${i}`));
        const detailContent = Array(randomInt(2, 10)).fill().map(() => `<p>${faker.lorem.paragraphs()}</p>`).join("");
        const aftersalesRules = Array(randomInt(2, 5)).fill().map(() => faker.lorem.sentence());
        document.getElementById('item-description').innerHTML = `
            <h2>Information</h2>
            <div class="desc-section">
                <h3>Key Specs</h3>
                <div class="attr-content">
                    <div class="attr-tags">Tags: ${tags.map((t, i) => `<span class="ant-tag ${tagColors[tags.length % tagColors.length]}">${t}</span>`).join('')}</div>
                    <div class="attr-tags">Attributes: ${Object.entries(attrs).map(([k, v], i) => `<span class="ant-tag ${tagColors[randomInt(0, 5) % tagColors.length]}">${k}: <b>${v}</b></span>`).join('')}</div>
                    <div class="field-tags">Fields: ${fields.map((f, i) => `<span class="ant-tag ${tagColors[fields.length % tagColors.length]}">${f}</span>`).join('')}</div>
                </div>
            </div>
            ${samplePics.length ? `
                <div class="desc-section">
                    <h3>Screenshots</h3>
                    <div class="sample-images">${samplePics.map(p => `<img src="${p}" alt="Sample" onclick="showModal('image-modal', '<img src=${p}>')">`).join('')}</div>
                </div>` : ''}
            <div class="desc-section">
                <h3>Description</h3>
                <p>${detailContent}</p>
            </div>
            <div class="desc-section">
                <h3>Rules</h3>
                <div class="aftersales-rules" id="aftersales-rules">
                    <p>售后时间: ${faker.datatype.number({ min: 24, max: 720 })}小时</p>
                    <ul>${aftersalesRules.map(r => `<li>${r}</li>`).join('')}</ul>
                    <a class="toggle-summary" onclick="toggleAftersales()">Show More</a>
                </div>
            </div>
        `;
    }

    function toggleAftersales() {
        const section = document.getElementById('aftersales-rules');
        section.classList.toggle('expanded');
        section.querySelector('.toggle-summary').textContent = section.classList.contains('expanded') ? 'Show Less' : 'Show More';
    }

    function renderItemFaqs() {
        const faqs = generateData(storeFaqFieldConfig, randomInt(1, 3));
        document.getElementById('item-faqs').innerHTML = `
            <h2>FAQs</h2>
            <div class="faq-list">${faqs.map(faq => `
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleAnswer(this)">
                        <span class="faq-question-text">${faq.question}</span>
                        <span><i class="fas fa-chevron-down faq-toggle"></i><i class="fas fa-chevron-up faq-toggle"></i></span>
                    </div>
                    <div class="faq-answer">${faq.answer}</div>
                </div>`).join('')}</div>
        `;
    }

    function toggleAnswer(element) {
        element.closest('.faq-item').classList.toggle('expanded');
    }

    function renderStoreInfo() {
        const deposit = randomInt(500, 5000);
        const languages = Array(randomInt(1, 3)).fill().map(() => faker.random.arrayElement(['English', 'Chinese', 'Spanish']));
        document.getElementById('store-info').innerHTML = `
            <h2>Store</h2>
            <div class="store-content">
                <div class="store-logo">
                    <img src="${storeData.image}" alt="${storeData.name}">
                    <span class="online-dot" style="background: ${storeData.online_status.sample === '在线' ? '#32CD32' : '#A9A9A9'}"></span>
                </div>
                <a href="store.html?name=${storeData.name}">
                    <div class="store-details">
                        <p style="font-weight: bold;font-size: var(--font-large)">${storeData.name}</p>
                        <p><i class="fas fa-check-circle" style="color: ${storeData.verified.sample === '已认证' ? 'var(--font-green)' : ''}"></i> ${storeData.verified.sample} <i class="fas fa-shield-alt"></i> 保证金: <b>$${deposit}</b></p>
    <!--                    <p><i class="fas fa-map-marker-alt"></i> ${faker.address.country()} <i class="fas fa-briefcase"></i> ${faker.datatype.number({ min: 8, max: 10 })}:00 - ${faker.datatype.number({ min: 18, max: 22 })}:00 <i class="fas fa-language"></i> ${languages.join(', ')}</p>-->
                        <div style="display: flex;gap: 0.5em;">销量: ${storeData.sales} ${generateRating(storeData, storeData.rating)}</div>
                    </div>
                </a>
            </div>
        `;
    }

    function renderItemReviews() {
        if (!reviews.length) reviews = generateData(ordersCommentFieldConfig, randomInt(10, 500));
        const total = reviews.length;
        document.getElementById('item-reviews').innerHTML = `
            <h2>Reviews</h2>
            <div class="review-header">
                <span>1-${Math.min(reviewsPerPage, total)} out of ${total} Reviews</span>
                <div class="review-sort">
                    <select class="ant-select" onchange="sortReviews(this.value)">
                        <option value="time">按最近时间</option>
                        <option value="amount">按订单金额降序</option>
                    </select>
                </div>
            </div>
            <div class="review-list" id="review-list">
                ${reviews.slice(0, reviewsPerPage).map((r, i) => renderReview(r, i)).join('')}
            </div>
            ${total > reviewsPerPage ? `<div class="show-more"><button class="btn-solid-medium" onclick="loadMoreReviews()">Show More Reviews</button></div>` : ''}
        `;
    }

    function renderReview(review, index) {
        const timeAgo = faker.random.arrayElement(['seconds', 'minutes', 'hours', 'days', 'months', 'years']);
        const timeValue = timeAgo === 'seconds' ? faker.datatype.number({ min: 1, max: 59 }) + ' s' :
            timeAgo === 'minutes' ? faker.datatype.number({ min: 1, max: 59 }) + ' min' :
                timeAgo === 'hours' ? faker.datatype.number({ min: 1, max: 23 }) + ' hr' :
                    timeAgo === 'days' ? faker.datatype.number({ min: 1, max: 30 }) + ' days' :
                        timeAgo === 'months' ? faker.datatype.number({ min: 1, max: 11 }) + ' mo' :
                            faker.datatype.number({ min: 1, max: 5 }) + ' yr';
        return `
            <div class="review-item">
                <div class="review-user">
                    <img src="${getPicsumImage(50, 50, `user-${index}`)}" alt="User">
                    <span>${faker.address.country()}</span>
                    <span>${faker.name.firstName()}</span>
                    ${Math.random() > 0.5 ? '<span class="text-success"><i class="fas fa-user-check"></i> Repeat Client</span>' : ''}
                </div>
                <hr>
                <div class="rating-wrapper">${generateRating(review, review.rating)} <span>${timeValue} ago</span></div>
                <p>${faker.lorem.paragraphs(randomInt(2, 3))}</p>
                <p>商品: <img src="${itemData.image}" alt="${itemName}" style="width: 2em; height: 2em; border-radius: 1em;">
                    <a href="item.html?name=${itemName}">${itemName}</a> - 数量: ${review.quantity} - <span style="color: var(--font-orange)">${review.total}</span> - ${timeValue} ago</p>
                <p class="review-store" onclick="toggleReply(this)">
                    <img src="${storeData.image}" alt="${storeData.name}" style="width: 1.5em; height: 1.5em; border-radius: 1em;">
                    <b>${storeData.name}</b> <i class="fas fa-chevron-down" style="float: right; margin-right: 2em;"></i>
                </p>
                <div class="review-reply">${faker.lorem.paragraph()}</div>
            </div>
            <p style="margin-bottom:2em;">Helpful?
                <span><i class="fas fa-thumbs-up" onclick="voteReview(this, 'yes', ${index})"></i> Yes</span>
                <span><i class="fas fa-thumbs-down" onclick="voteReview(this, 'no', ${index})"></i> No</span>
            </p>
        `;
    }

    function sortReviews(type) {
        if (type === 'time') reviews.sort(() => 0);
        else reviews.sort((a, b) => parseFloat(b.total.replace('$', '')) - parseFloat(a.total.replace('$', '')));
        renderItemReviews();
    }

    function toggleReply(element) {
        const reply = element.closest('.review-item').querySelector('.review-reply');
        reply.classList.toggle('expanded');
        element.querySelector('i').classList.toggle('fa-chevron-down');
        element.querySelector('i').classList.toggle('fa-chevron-up');
    }

    function loadMoreReviews() {
        reviewPage++;
        const start = (reviewPage - 1) * reviewsPerPage;
        const newReviews = reviews.slice(start, start + reviewsPerPage);
        document.getElementById('review-list').innerHTML += newReviews.map((r, i) => renderReview(r, i)).join('');
    }

    function renderItemSidebar() {
        document.getElementById('item-sidebar').innerHTML = `
            <div class="item-sidebar-inner">
                <h2 style="text-align: center">Item's Statistics</h2>
                <div class="stats-area">
                    <div class="rating-overview">
                        <div class="rating-group">
                            ${generateRating(storeData, storeData.rating)}
                        </div>
                        <div class="rating-group">
                            <span>评分: <span style="color: ${getRatingColor(4.3)}">4.3</span> (90)</span>
                            <span>服务: <span style="color: ${getRatingColor(4.1)}">4.1</span></span>
                            <span>物流: <span style="color: ${getRatingColor(4.6)}">4.6</span></span>
                            <span>商品: <span style="color: ${getRatingColor(4.4)}">4.4</span></span>
                        </div>
                        ${[5, 4, 3, 2, 1].map(i => {
                            const count = faker.datatype.number({ min: 10, max: 100 });
                            return `<div class="rating-bar">${i}星 <progress value="${count}" max="100"></progress> ${count}</div>`;
                        }).join('')}
                        </div>
                        <div class="chart-tabs">
                            <span class="chart-tab" data-days="7" onclick="renderChart(7)">7天</span>
                            <span class="chart-tab" data-days="14" onclick="renderChart(14)">14天</span>
                            <span class="chart-tab active" data-days="30" onclick="renderChart(30)">30天</span>
                        </div>
                        <h4>Overview</h4>
                        <canvas id="overview-chart" class="chart-container"></canvas>
                        <h4>Sales Count</h4>
                        <canvas id="sales-chart" class="chart-container"></canvas>
                    </div>
                </div>
            `;
        renderChart(7);
    }

    function getRatingColor(rating) {
        if (rating >= 4.5) return '#32CD32';
        if (rating >= 4.0) return '#FF9900';
        return '#FF4500';
    }

    function renderChart(days) {
        const overviewCtx = document.getElementById('overview-chart')?.getContext('2d');
        const salesCtx = document.getElementById('sales-chart')?.getContext('2d');
        if (!overviewCtx || !salesCtx) return;
        const labels = Array(days).fill().map((_, i) => `${days - i}d`);
        const overviewData = {
            labels,
            datasets: [
                { label: '好评率', data: Array(days).fill().map(() => faker.datatype.float({ min: 80, max: 100 })), borderColor: '#32CD32' },
                { label: '响应率', data: Array(days).fill().map(() => faker.datatype.float({ min: 70, max: 100 })), borderColor: '#4682B4' },
                { label: '充足率', data: Array(days).fill().map(() => faker.datatype.float({ min: 60, max: 100 })), borderColor: '#FFD700' }
            ]
        };
        const salesData = {
            labels,
            datasets: [
                { label: '销售量', data: Array(days).fill().map(() => faker.datatype.number({ min: 50, max: 200 })), borderColor: '#FF4500' },
                { label: '退款量', data: Array(days).fill().map(() => faker.datatype.number({ min: 0, max: 50 })), borderColor: '#800080' },
                { label: '新增量', data: Array(days).fill().map(() => faker.datatype.number({ min: 0, max: 200 })), borderColor: '#00CED1' }
            ]
        };
        if (overviewChartInstance) overviewChartInstance.destroy();
        if (salesChartInstance) salesChartInstance.destroy();
        overviewChartInstance = new Chart(overviewCtx, { type: 'line', data: overviewData, options: { scales: { y: { beginAtZero: true } }, elements: { line: { tension: 0.5 } } } });
        salesChartInstance = new Chart(salesCtx, { type: 'line', data: salesData, options: { scales: { y: { beginAtZero: true } }, elements: { line: { tension: 0.5 } } } });
        document.querySelectorAll('.chart-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelector(`.chart-tab[data-days="${days}"]`).classList.add('active');
    }

    function changeQuantity(delta) {
        quantity = Math.max(1, quantity + delta);
        document.getElementById('quantity').value = quantity;
        updateTotal();
    }

    function updateTotal() {
        quantity = parseInt(document.getElementById('quantity').value) || 1;
        const price = parseFloat(itemData.price.replace('$', ''));
        const total = (price * quantity).toFixed(2);
        document.getElementById('total-price').style.display = 'block';
        document.getElementById('total-price').innerHTML = `Total price: <b style="color: red;">$${total}</b>`;
    }

    function buyNow() {
        alert(`购买 ${quantity} 件 ${itemName}，总价: $${(parseFloat(itemData.price.replace('$', '')) * quantity).toFixed(2)}`);
    }

    function renderSimilarItems() {
        const similarItems = generateData(itemFieldConfig, 6).map(item => ({ ...item, brandName: itemData.brandName, service: itemData.service }));
        const container = document.getElementById('similar-items');
        container.innerHTML = `<h2>Similar Items</h2><div class="scroll-list" id="similar-list"></div>`;
        generateCards('similar-list', 'card', similarItems, itemFieldConfig);
    }

    // 新增渲染页签函数
    function renderItemTabs() {
        const tabsContainer = document.getElementById('item-tabs');
        let sections = document.querySelectorAll('.item-content h2 , .similar-items h2');
        tabsContainer.innerHTML = Array.from(sections).map((h2, index) => {
            const id = `section-${index}`;
            h2.id = id; // 为每个 h2 添加唯一 ID
            return `<span class="item-tab" data-section="${id}">${h2.textContent}</span>`;
        }).join('');

        // 点击跳转
        document.querySelectorAll('.item-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const sectionId = tab.getAttribute('data-section');
                const section = document.getElementById(sectionId);
                window.scrollTo({
                    top: section.offsetTop - document.getElementById('item-top').offsetHeight,
                    behavior: 'smooth'
                });
                setActiveTab(sectionId);
            });
        });
    }

    // 设置激活的页签
    function setActiveTab(sectionId) {
        document.querySelectorAll('.item-tab').forEach(tab => tab.classList.remove('active'));
        const activeTab = document.querySelector(`.item-tab[data-section="${sectionId}"]`);
        if (activeTab) activeTab.classList.add('active');
    }

    // 处理滚动时自动选中页签
    function handleScroll() {
        const header = document.querySelector('.header');
        const breadcrumbTop = document.getElementById('breadcrumb-wrapper');
        const itemTop = document.getElementById('item-top');
        const itemSidebar = document.getElementById('item-sidebar');
        const contentSection = document.querySelector('.content-section');
        const scrollY = window.scrollY;
        const headerHeight = itemTop.offsetHeight + breadcrumbTop.offsetHeight;
        const sidebarHeight = itemSidebar.offsetHeight;
        const contentSectionHeight = contentSection.offsetHeight;
        const contentSectionTop = contentSection.getBoundingClientRect().top + window.scrollY;

        // 处理 item-top 的固定和隐藏
        if (scrollY > headerHeight) {
            header.classList.add('hidden');
            itemTop.classList.add('fixed');
            document.body.style.paddingTop = `${itemTop.offsetHeight}px`;
            document.documentElement.style.setProperty('--item-top-height', `${itemTop.offsetHeight}px`);
        } else {
            header.classList.remove('hidden');
            itemTop.classList.remove('fixed');
            document.body.style.paddingTop = '7.4em';
            document.documentElement.style.setProperty('--item-top-height', '0px');
        }

        // 处理 item-sidebar 的显示/隐藏
        const triggerPoint = contentSectionTop + contentSectionHeight - sidebarHeight - itemTop.offsetHeight;
        if (scrollY >= triggerPoint) {
            itemSidebar.style = ""
        } else {
            itemSidebar.style = "position:fixed;"
        }

        // 滚动时自动选中页签
        const sections = document.querySelectorAll('.item-content h2');
        let currentSection = null;
        sections.forEach(section => {
            const rect = section.getBoundingClientRect();
            if (rect.top <= itemTop.offsetHeight + 50 && rect.bottom > 0) {
                currentSection = section.id;
            }
        });
        if (currentSection) setActiveTab(currentSection);
    }
    window.onload = () => {
        w3.includeHTML(() => {
            renderItemInfo();
            renderBreadcrumb();
            renderItemDescription();
            renderItemFaqs();
            renderStoreInfo();
            renderItemReviews();
            renderItemSidebar();
            renderSimilarItems();
            renderItemTabs(); // 渲染页签

            setTimeout(() => {
                window.addEventListener('scroll', handleScroll);
                handleScroll(); // 初始调用
                setActiveTab('section-0'); // 默认选中第一个页签


                const feedbackForm = document.getElementById('feedback-form');
                if (feedbackForm) {
                    feedbackForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        alert('反馈已提交，感谢您的意见！');
                        closePopup('feedback-popup');
                    });
                }

                document.querySelectorAll('.popup-overlay').forEach(popup => {
                    popup.addEventListener('click', (e) => {
                        if (e.target === popup) {
                            closePopup(popup.id);
                        }
                    });
                });

                document.querySelectorAll('.share-social i').forEach(icon => {
                    icon.addEventListener('click', () => {
                        const platform = icon.className.includes('facebook') ? 'facebook' :
                            icon.className.includes('twitter') ? 'twitter' :
                                icon.className.includes('linkedin') ? 'linkedin' : '';
                        if (platform) shareToSocial(platform);
                    });
                });

                const complaintType = document.getElementById('complaint-type');
                if (complaintType) {
                    complaintType.addEventListener('change', updateFeedbackForm);
                }

            }, 300);
        });
    };
</script>
</body>
</html>