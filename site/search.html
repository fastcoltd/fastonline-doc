<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>搜索 - FASTRESP</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/antd/4.24.10/antd.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="_style.css">
    <link rel="stylesheet" href="_site.css">
    <style>
        .search-container { display: flex; gap: 2em; padding: 2em 0; }
        .sidebar { flex: 0 0 20em; background: var(--bg-white); padding: 1em; border-radius: 0.5em; box-shadow: 0 0.125em 0.3125em rgba(0,0,0,0.1); }
        .main-content { flex: 1; }
        .filter-row { display: flex; align-items: center; gap: 1em; margin-bottom: 0.75em; }
        .filter-row label { font-size: var(--font-small); color: var(--text-secondary); white-space: nowrap; }
        .filter-row .ant-input, .filter-row .ant-select { flex: 1; }
        .filter-row .ant-input-number { width: 5em; }
        .tag-list { display: flex; flex-wrap: wrap; gap: 0.5em; margin-top: 0.5em; }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1em; font-size: var(--font-medium); color: var(--text-primary); }
        .search-card { display: flex; align-items: center; padding: 1em; border: 0.0625em solid var(--border-color); border-radius: 0.5em; margin-bottom: 0.5em; cursor: pointer; background: var(--bg-white); transition: all 0.2s; }
        .search-card:hover { border-color: var(--vibrant-orange); box-shadow: 0 0.3125em 0.9375em rgba(0,0,0,0.1); }
        .search-card img { width: 6em; height: 6em; object-fit: cover; margin-right: 1em; border-radius: 0.25em; }
        .search-card-content { flex: 1; }
        .search-card-content h3 { font-size: var(--font-medium); margin: 0 0 0.5em; color: var(--text-primary); }
        .search-card-content p { font-size: var(--font-small); color: var(--text-secondary); margin: 0.3em 0; }
        .search-card-content .price { color: var(--vibrant-orange); font-weight: bold; }
        .search-card-content .ant-tag { margin-right: 0.5em; }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 1em; margin-top: 1.5em; font-size: var(--font-small); color: var(--text-primary); }
        .pagination .ant-btn { padding: 0.3em 1em; background: var(--bg-white); border-color: var(--border-color); }
        .pagination .ant-btn:hover { border-color: var(--natural-green); color: var(--natural-green); }
        .pagination .ant-select { width: 6em; }
    </style>
</head>
<body>
<!-- 头部 -->
<div w3-include-html="_header.html"></div>

<!-- 主内容 -->
<div class="container">
    <div class="search-container">
        <!-- 侧边栏 -->
        <div class="sidebar">
            <div class="filter-row">
                <label>搜索类型:</label>
                <select class="ant-select ant-select-single ant-select-show-arrow" id="search-type">
                    <option value="items">商品</option>
                    <option value="stores">店铺</option>
                    <option value="posts">文章</option>
                    <option value="demands">需求</option>
                </select>
            </div>
            <div class="filter-row">
                <label>品牌:</label>
                <input class="ant-input" list="brand-list" id="brand-filter" placeholder="输入品牌快速定位">
                <datalist id="brand-list"></datalist>
            </div>
            <div class="filter-row">
                <label>服务:</label>
                <input class="ant-input" list="service-list" id="service-filter" placeholder="输入服务快速定位">
                <datalist id="service-list"></datalist>
            </div>
            <div class="filter-row">
                <label>属性:</label>
                <select class="ant-select ant-select-single ant-select-show-arrow" id="attribute-type" onchange="updateAttributeValues()">
                    <option value="">选择属性类型</option>
                </select>
                <select class="ant-select ant-select-single ant-select-show-arrow" id="attribute-value" onchange="addAttributeTag()">
                    <option value="">选择属性值</option>
                </select>
            </div>
            <div id="attribute-tags" class="tag-list"></div>
            <div class="filter-row">
                <label>价格:</label>
                <input class="ant-input-number" type="number" id="price-min" placeholder="最低" min="0">
                <span>~</span>
                <input class="ant-input-number" type="number" id="price-max" placeholder="最高" min="0">
            </div>
            <div class="filter-row">
                <label>库存:</label>
                <input class="ant-input-number" type="number" id="stock-min" placeholder="最小" min="0">
                <span>~</span>
                <input class="ant-input-number" type="number" id="stock-max" placeholder="最大" min="0">
            </div>
            <div class="filter-row">
                <label>评分:</label>
                <input class="ant-input-number" type="number" id="rating-min" placeholder="最低" min="0" max="5" step="0.1">
                <span>~</span>
                <input class="ant-input-number" type="number" id="rating-max" placeholder="最高" min="0" max="5" step="0.1">
            </div>
            <div class="filter-row">
                <label>更新时间晚于:</label>
                <input class="ant-input" type="datetime-local" id="update-time">
            </div>
            <div class="filter-row">
                <label>标签:</label>
                <select class="ant-select ant-select-single ant-select-show-arrow" id="tag-filter" onchange="addTag()">
                    <option value="">选择标签</option>
                </select>
            </div>
            <div id="tag-list" class="tag-list"></div>
            <button class="ant-btn ant-btn-primary btn-orange-solid-medium" onclick="applyFilters()" style="width: 100%; margin-top: 1em;">应用筛选</button>
        </div>

        <!-- 主要内容 -->
        <div class="main-content">
            <div class="result-header">
                <div>搜索 "<span id="search-keyword"></span>"，找到 <span id="result-count">0</span> 条结果</div>
                <select class="ant-select ant-select-single ant-select-show-arrow" id="sort-by" onchange="sortResults()">
                    <option value="relevance">按相关性排序</option>
                    <option value="price">按价格排序</option>
                    <option value="rating">按评分排序</option>
                    <option value="stock">按库存排序</option>
                    <option value="sales">按销量排序</option>
                </select>
            </div>
            <div id="search-results"></div>
            <div class="pagination">
                <button class="ant-btn" onclick="changePage(-1)">上一页</button>
                <span id="pagination-info"></span>
                <button class="ant-btn" onclick="changePage(1)">下一页</button>
                <span>跳转到 <input class="ant-input" type="number" id="jump-to-page" min="1" style="width: 4em;"></span>
                <span>每页 <select class="ant-select ant-select-single ant-select-show-arrow" id="items-per-page" onchange="updateResults()">
                    <option value="10">10</option>
                    <option value="20" selected>20</option>
                    <option value="50">50</option>
                </select> 条</span>
            </div>
        </div>
    </div>
</div>

<!-- 底部 -->
<div w3-include-html="_footer.html"></div>

<!-- 脚本 -->
<script src="https://www.w3schools.com/lib/w3.js"></script>
<script src="https://cdn.jsdelivr.net/npm/faker@5.5.3/dist/faker.min.js"></script>
<script src="_fields.js"></script>
<script src="_data.js"></script>
<script src="_common.js"></script>
<script src="_location.js"></script>
<script src="_member.js"></script>
<script>
    let currentPage = 1;
    let itemsPerPage = 20;
    let searchType = 'items';
    let searchKeyword = '';
    let filteredResults = [];
    let allResults = [];
    let availableTags = [...ecommerceTags]; // 可用标签列表

    // 初始化筛选
    function initFilters() {
        const brandList = document.getElementById('brand-list');
        hotPlatforms.forEach(p => {
            const option = document.createElement('option');
            option.value = p.name;
            brandList.appendChild(option);
        });

        const serviceList = document.getElementById('service-list');
        hotServices.forEach(s => {
            const option = document.createElement('option');
            option.value = s.title;
            serviceList.appendChild(option);
        });

        const attributeType = document.getElementById('attribute-type');
        Object.keys(ecommerceAttributes).forEach(attr => {
            const option = document.createElement('option');
            option.value = attr;
            option.text = attr;
            attributeType.appendChild(option);
        });

        updateTagFilter();
    }

    // 更新标签下拉框
    function updateTagFilter() {
        const tagFilter = document.getElementById('tag-filter');
        tagFilter.innerHTML = '<option value="">选择标签</option>';
        availableTags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag;
            option.text = tag;
            tagFilter.appendChild(option);
        });
    }

    // 更新属性值下拉框
    function updateAttributeValues() {
        const type = document.getElementById('attribute-type').value;
        const valueSelect = document.getElementById('attribute-value');
        valueSelect.innerHTML = '<option value="">选择属性值</option>';
        if (type && ecommerceAttributes[type]) {
            ecommerceAttributes[type].forEach(val => {
                const option = document.createElement('option');
                option.value = val;
                option.text = val;
                valueSelect.appendChild(option);
            });
        }
    }

    // 添加属性标签
    function addAttributeTag() {
        const type = document.getElementById('attribute-type').value;
        const value = document.getElementById('attribute-value').value;
        if (type && value) {
            const tags = document.getElementById('attribute-tags');
            const tag = document.createElement('span');
            tag.className = 'ant-tag ant-tag-blue';
            tag.innerHTML = `${type}: ${value} <span class="anticon anticon-close close" onclick="removeTag(this, 'attribute-tags')"></span>`;
            tags.appendChild(tag);
            document.getElementById('attribute-value').value = '';
            applyFilters();
        }
    }

    // 添加普通标签
    function addTag() {
        const value = document.getElementById('tag-filter').value;
        if (value) {
            const tags = document.getElementById('tag-list');
            const tag = document.createElement('span');
            tag.className = 'ant-tag ant-tag-blue';
            tag.innerHTML = `${value} <span class="anticon anticon-close close" onclick="removeTag(this, 'tag-list')"></span>`;
            tags.appendChild(tag);
            availableTags = availableTags.filter(t => t !== value);
            document.getElementById('tag-filter').value = '';
            updateTagFilter();
            applyFilters();
        }
    }

    // 删除标签
    function removeTag(element, containerId) {
        const tagText = element.parentElement.textContent.trim().replace('', '');
        if (containerId === 'tag-list') {
            availableTags.push(tagText);
            updateTagFilter();
        }
        element.parentElement.remove();
        applyFilters();
    }

    // 生成搜索数据
    function generateSearchData() {
        const data = [];
        const count = 100;
        for (let i = 0; i < count; i++) {
            let item;
            switch (searchType) {
                case 'items':
                    item = generateData(productFieldConfig, 1)[0];
                    item.brandName = hotPlatforms[Math.floor(Math.random() * hotPlatforms.length)].name;
                    item.tags = ecommerceTags.slice(0, Math.floor(Math.random() * 3) + 1);
                    item.updateTime = faker.date.recent(30).toISOString();
                    item.description = faker.lorem.sentence();
                    item.seller = faker.company.companyName();
                    item.shipping = ecommerceTags[Math.floor(Math.random() * ecommerceTags.length)];
                    break;
                case 'stores':
                    item = generateData(shopFieldConfig, 1)[0];
                    item.tags = ecommerceTags.slice(0, Math.floor(Math.random() * 3) + 1);
                    item.updateTime = faker.date.recent(30).toISOString();
                    item.description = faker.lorem.sentence();
                    item.location = faker.address.city();
                    item.products = faker.datatype.number({ min: 10, max: 100 });
                    break;
                case 'posts':
                    item = generateData(articleFieldConfig, 1)[0];
                    item.tags = ecommerceTags.slice(0, Math.floor(Math.random() * 3) + 1);
                    item.updateTime = faker.date.recent(30).toISOString();
                    item.summary = faker.lorem.paragraph();
                    item.views = faker.datatype.number({ min: 100, max: 10000 });
                    break;
                case 'demands':
                    item = generateData(demandFieldConfig, 1)[0];
                    item.tags = ecommerceTags.slice(0, Math.floor(Math.random() * 3) + 1);
                    item.updateTime = faker.date.recent(30).toISOString();
                    item.deadline = faker.date.future().toISOString().split('T')[0];
                    item.buyer = faker.name.findName();
                    break;
            }
            const attrKeys = Object.keys(ecommerceAttributes);
            item.attributes = {};
            for (let j = 0; j < 3; j++) {
                const key = attrKeys[Math.floor(Math.random() * attrKeys.length)];
                item.attributes[key] = ecommerceAttributes[key][Math.floor(Math.random() * ecommerceAttributes[key].length)];
            }
            data.push(item);
        }
        return data;
    }

    // 应用筛选
    function applyFilters() {
        const brand = document.getElementById('brand-filter').value;
        const service = document.getElementById('service-filter').value;
        const priceMin = parseFloat(document.getElementById('price-min').value) || 0;
        const priceMax = parseFloat(document.getElementById('price-max').value) || Infinity;
        const stockMin = parseInt(document.getElementById('stock-min').value) || 0;
        const stockMax = parseInt(document.getElementById('stock-max').value) || Infinity;
        const ratingMin = parseFloat(document.getElementById('rating-min').value) || 0;
        const ratingMax = parseFloat(document.getElementById('rating-max').value) || 5;
        const updateTime = document.getElementById('update-time').value;
        const attributeTags = Array.from(document.getElementById('attribute-tags').children).map(tag => {
            const [type, value] = tag.textContent.split(': ').map(t => t.trim().replace('', ''));
            return { type, value };
        });
        const tags = Array.from(document.getElementById('tag-list').children).map(tag => tag.textContent.trim().replace('', ''));

        filteredResults = allResults.filter(item => {
            let match = true;
            if (brand && item.brandName !== brand) match = false;
            if (service && item.title !== service) match = false;
            if (item.price) {
                const price = parseFloat(item.price.sample.replace('$', ''));
                if (price < priceMin || price > priceMax) match = false;
            }
            if (item.stock && (item.stock < stockMin || item.stock > stockMax)) match = false;
            if (item.rating && (item.rating < ratingMin || item.rating > ratingMax)) match = false;
            if (updateTime && item.updateTime && new Date(item.updateTime) < new Date(updateTime)) match = false;
            if (attributeTags.length > 0) {
                attributeTags.forEach(tag => {
                    if (!item.attributes[tag.type] || item.attributes[tag.type] !== tag.value) match = false;
                });
            }
            if (tags.length > 0 && !tags.every(tag => item.tags.includes(tag))) match = false;
            return match && (item.title?.toLowerCase().includes(searchKeyword.toLowerCase()) ||
                item.name?.toLowerCase().includes(searchKeyword.toLowerCase()) ||
                item.demandName?.toLowerCase().includes(searchKeyword.toLowerCase()) ||
                item.description?.toLowerCase().includes(searchKeyword.toLowerCase()) ||
                item.summary?.toLowerCase().includes(searchKeyword.toLowerCase()));
        });
        currentPage = 1;
        updateResults();
    }

    // 更新结果显示
    function updateResults() {
        itemsPerPage = parseInt(document.getElementById('items-per-page').value);
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const results = filteredResults.slice(start, end);
        const container = document.getElementById('search-results');
        container.innerHTML = '';

        results.forEach(item => {
            const card = document.createElement('div');
            card.className = 'search-card';
            card.innerHTML = `
                <img src="${item.image || placeholderImage}" alt="${item.title || item.name}">
                <div class="search-card-content">
                    <h3>${item.title || item.name || item.demandName}</h3>
                    ${item.description ? `<p>描述: ${item.description}</p>` : item.summary ? `<p>摘要: ${item.summary}</p>` : ''}
                    ${item.price ? `<p>价格: <span class="price">${item.price}</span></p>` : item.totalPrice ? `<p>总价: <span class="price">${item.totalPrice}</span></p>` : ''}
                    ${item.stock ? `<p>库存: ${item.stock}</p>` : item.productCount ? `<p>需求数量: ${item.productCount}</p>` : ''}
                    ${item.rating ? `<div class="rating">${generateRating(item, item.rating)}</div>` : ''}
                    ${item.seller ? `<p>卖家: ${item.seller}</p>` : item.buyer ? `<p>买家: ${item.buyer}</p>` : item.author ? `<p>作者: ${item.author}</p>` : ''}
                    ${item.shipping ? `<p>配送: ${item.shipping}</p>` : item.deadline ? `<p>截止日期: ${item.deadline}</p>` : item.views ? `<p>浏览量: ${item.views}</p>` : ''}
                    ${item.location ? `<p>位置: ${item.location}</p>` : ''}
                    ${item.products ? `<p>商品数: ${item.products}</p>` : ''}
                    ${item.tags ? `<p>${item.tags.map(tag => `<span class="ant-tag ant-tag-blue">${tag}</span>`).join('')}</p>` : ''}
                </div>
                <i class="fas fa-heart favorite-icon ${item.favorite ? 'favorited' : ''}" onclick="toggleFavorite(this)" style="font-size: var(--font-large); margin-left: 1em;"></i>
            `;
            container.appendChild(card);
        });

        document.getElementById('result-count').textContent = filteredResults.length;
        document.getElementById('search-keyword').textContent = searchKeyword;
        updatePagination();
    }

    // 切换收藏状态
    function toggleFavorite(element) {
        element.classList.toggle('favorited');
    }

    // 更新分页信息
    function updatePagination() {
        const totalPages = Math.ceil(filteredResults.length / itemsPerPage);
        let paginationHtml = '';
        if (totalPages <= 7) {
            for (let i = 1; i <= totalPages; i++) {
                paginationHtml += `<a href="#" onclick="goToPage(${i})" ${i === currentPage ? 'style="font-weight: bold; color: var(--vibrant-orange);"' : ''}>${i}</a>`;
            }
        } else {
            paginationHtml += `<a href="#" onclick="goToPage(1)" ${currentPage === 1 ? 'style="font-weight: bold; color: var(--vibrant-orange);"' : ''}>1</a>`;
            if (currentPage > 4) paginationHtml += '<span>...</span>';
            for (let i = Math.max(2, currentPage - 2); i <= Math.min(totalPages - 1, currentPage + 2); i++) {
                paginationHtml += `<a href="#" onclick="goToPage(${i})" ${i === currentPage ? 'style="font-weight: bold; color: var(--vibrant-orange);"' : ''}>${i}</a>`;
            }
            if (currentPage < totalPages - 3) paginationHtml += '<span>...</span>';
            paginationHtml += `<a href="#" onclick="goToPage(${totalPages})" ${currentPage === totalPages ? 'style="font-weight: bold; color: var(--vibrant-orange);"' : ''}>${totalPages}</a>`;
        }
        document.getElementById('pagination-info').innerHTML = paginationHtml;
        document.getElementById('jump-to-page').max = totalPages;
    }

    // 跳转页面
    function goToPage(page) {
        currentPage = page;
        updateResults();
    }

    function changePage(delta) {
        const totalPages = Math.ceil(filteredResults.length / itemsPerPage);
        currentPage = Math.max(1, Math.min(totalPages, currentPage + delta));
        updateResults();
    }

    // 按字段排序
    function sortResults() {
        const sortBy = document.getElementById('sort-by').value;
        filteredResults.sort((a, b) => {
            if (sortBy === 'relevance') return 0;
            if (sortBy === 'price') return parseFloat(a.price?.replace('$', '') || a.totalPrice?.replace('$', '') || 0) - parseFloat(b.price?.replace('$', '') || b.totalPrice?.replace('$', '') || 0);
            if (sortBy === 'rating') return (b.rating || 0) - (a.rating || 0);
            if (sortBy === 'stock') return (b.stock || b.productCount || 0) - (a.stock || a.productCount || 0);
            if (sortBy === 'sales') return (b.sales || 0) - (a.sales || 0);
        });
        updateResults();
    }

    // 初始化页面
    window.onload = () => {
        w3.includeHTML(() => {
            initFilters();

            // 从头部搜索框读取关键字
            const searchInput = document.getElementById('search');
            if (searchInput) {
                searchKeyword = searchInput.value || 'test';
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchKeyword = searchInput.value;
                        allResults = generateSearchData();
                        filteredResults = [...allResults];
                        applyFilters();
                    }
                });
            } else {
                searchKeyword = new URLSearchParams(window.location.search).get('q') || 'test';
            }

            document.getElementById('search-type').value = searchType;
            document.getElementById('search-type').onchange = () => {
                searchType = document.getElementById('search-type').value;
                allResults = generateSearchData();
                filteredResults = [...allResults];
                applyFilters();
            };
            document.getElementById('jump-to-page').onchange = () => {
                const page = parseInt(document.getElementById('jump-to-page').value);
                if (page >= 1 && page <= Math.ceil(filteredResults.length / itemsPerPage)) {
                    currentPage = page;
                    updateResults();
                }
            };
            allResults = generateSearchData();
            filteredResults = [...allResults];
            applyFilters();
        });
    };
</script>
</body>
</html>