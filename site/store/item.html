<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品编辑</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/antd/4.24.16/antd.min.css">
    <link rel="stylesheet" href="/site/_site.css">
    <link rel="stylesheet" href="/site/store/_store.css">
    <script src="https://www.w3schools.com/lib/w3.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/faker@5.5.3/dist/faker.min.js"></script>
    <script src="/site/_fields.js"></script>
    <script src="/site/_data.js"></script>
    <script src="/site/_location.js"></script>
    <script src="/site/_member.js"></script>
    <script src="/site/_common.js"></script>
    <script src="/site/store/_store.js"></script>
    <style>
        .tips {background:#fefcbf;border:1px solid #f6e05e;border-radius:0.25em;padding:1em;margin-bottom:1em;}
        .tips p {margin:0;color:#744210;}
        .item-edit-container {padding:1em;}
        .form-group {flex:1;min-width:0;display:flex;align-items:center;margin-bottom:0.75em;}
        .form-group label {width:100px;font-size:0.875em;color:#1f2937;white-space:nowrap;text-align:right;margin-right:0.5em;}
        .form-group input, .form-group select, .form-group textarea {flex:1;padding:0.5em;border:1px solid #d9d9d9;border-radius:0.25em;font-size:0.875em;}
        .form-group textarea {height:6em;resize:vertical;}
        .form-section {margin-bottom:1.5em;}
        .form-section h3 {font-size:1.1em;color:#1f2937;margin-bottom:0.5em;}
        .action-btn-save {padding:0.5em 1em;border-radius:0.25em;cursor:pointer;background:#4CAF50;color:#fff;border:none;font-size:0.875em;margin-right:0.5em;}
        .action-btn-save:hover {background:#45a049;}
        .action-btn-cancel {padding:0.5em 1em;border-radius:0.25em;cursor:pointer;background:#FF4500;color:#fff;border:none;font-size:0.875em;}
        .action-btn-cancel:hover {background:#D63B00;}
        .language-set {background:#e6ffed;}
        .language-unset {background:#f5f5f5;}
    </style>
</head>
<body>
<div w3-include-html="/site/_header.html"></div>
<div class="store-container">
    <div class="store-messages" id="store-messages"></div>
    <div class="sidebar-main-wrapper">
        <div w3-include-html="/site/store/_sidebar.html"></div>
        <div class="main-content">
            <h2 id="page-title">添加商品</h2>
            <div class="item-edit-container">
                <div class="form-section">
                    <div class="form-group">
                        <label>选择语言</label>
                        <select id="language-selector"></select>
                    </div>
                </div>
                <div class="form-section">
                    <h3>商品信息</h3>
                    <div class="form-group">
                        <label>品牌</label>
                        <select id="edit-brand_id"></select>
                    </div>
                    <div class="form-group">
                        <label>服务</label>
                        <select id="edit-services_id"></select>
                    </div>
                    <div class="form-group">
                        <label>状态</label>
                        <select id="edit-status">
                            <option value="0">禁用</option>
                            <option value="1">启用</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>发货方式</label>
                        <select id="edit-delivery_type">
                            <option value="0">标准运输</option>
                            <option value="1">快速运输</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>库存数量</label>
                        <input type="number" id="edit-stock_quantity" min="0">
                    </div>
                    <div class="form-group">
                        <label>低库存提醒</label>
                        <input type="number" id="edit-lower_notice_quantity" min="0">
                    </div>
                    <div class="form-group">
                        <label>售后时间(秒)</label>
                        <input type="number" id="edit-after_sales_time" min="0">
                    </div>
                    <div class="form-group">
                        <label>价格</label>
                        <input type="number" id="edit-price" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>原价</label>
                        <input type="number" id="edit-original_price" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>保质期(天)</label>
                        <input type="number" id="edit-shelf_life" min="1">
                    </div>
                </div>
                <div class="form-section">
                    <h3>多语言信息</h3>
                    <div class="form-group">
                        <label>商品名称</label>
                        <input type="text" id="edit-name">
                    </div>
                    <div class="form-group">
                        <label>SEO关键词</label>
                        <input type="text" id="edit-seo_keywords">
                    </div>
                    <div class="form-group">
                        <label>SEO描述</label>
                        <input type="text" id="edit-seo_description">
                    </div>
                    <div class="form-group">
                        <label>售后规则</label>
                        <textarea id="edit-after_sales_rules"></textarea>
                    </div>
                </div>
                <div class="form-section">
                    <button class="action-btn-save" onclick="saveItem()">保存</button>
                    <button class="action-btn-cancel" onclick="cancelEdit()">取消</button>
                </div>
            </div>
        </div>
    </div>
</div>
<div w3-include-html="/site/_footer.html"></div>
<script>
    window.addEventListener('load', () => {
        w3.includeHTML(() => {
            initSidebar();
            InitSidebarContent();
            initStoreMessages();
            initializeForm();
        });
    });

    let currentItem = null;
    let currentLangCode = 'en_US';
    const itemId = new URLSearchParams(window.location.search).get('id');

    // 随机整数函数
    function randomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // 初始化表单
    function initializeForm() {
        // 加载品牌和服务
        const brandSelect = document.getElementById('edit-brand_id');
        brandSelect.innerHTML = `<option value="">选择品牌</option>` +
            hotBrands.map(brand => `<option value="${brand.id}">${brand.name}</option>`).join('');

        const serviceSelect = document.getElementById('edit-services_id');
        serviceSelect.innerHTML = `<option value="">选择服务</option>` +
            services.map(service => `<option value="${service.id}">${service.name}</option>`).join('');

        // 加载语言选择器
        const langSelect = document.getElementById('language-selector');
        langSelect.innerHTML = window.languages.map(lang => {
            const langCode = `${lang.code}_US`;
            const isSet = itemId && allItems.find(item => item.id == itemId)?.item_lang[langCode]?.name ? '已设置' : '未设置';
            const className = isSet === '已设置' ? 'language-set' : 'language-unset';
            return `<option value="${langCode}" class="${className}">${lang.name} (${langCode}) - ${isSet}</option>`;
        }).join('');
        langSelect.addEventListener('change', updateLangFields);

        // 判断添加或编辑
        if (itemId) {
            document.getElementById('page-title').textContent = '编辑商品';
            currentItem = allItems.find(item => item.id == itemId);
            if (currentItem) {
                loadItemData();
            } else {
                alert('商品不存在！');
                window.location.href = '/site/store/item-manage.html';
            }
        } else {
            currentItem = {
                item_lang: {}
            };
            window.languages.forEach(lang => {
                const langCode = `${lang.code}_US`;
                currentItem.item_lang[langCode] = {
                    name: '',
                    seo_keywords: '',
                    seo_description: '',
                    after_sales_rules: ''
                };
            });
            updateLangFields();
        }
    }

    // 加载商品数据
    function loadItemData() {
        document.getElementById('edit-brand_id').value = currentItem.brand_id || '';
        document.getElementById('edit-services_id').value = currentItem.services_id || '';
        document.getElementById('edit-status').value = currentItem.status || '0';
        document.getElementById('edit-delivery_type').value = currentItem.delivery_type || '0';
        document.getElementById('edit-stock_quantity').value = currentItem.stock_quantity || '0';
        document.getElementById('edit-lower_notice_quantity').value = currentItem.lower_notice_quantity || '0';
        document.getElementById('edit-after_sales_time').value = currentItem.after_sales_time || '0';
        document.getElementById('edit-price').value = currentItem.price || '0';
        document.getElementById('edit-original_price').value = currentItem.original_price || '0';
        document.getElementById('edit-shelf_life').value = currentItem.shelf_life || '1';
        updateLangFields();
    }

    // 更新多语言字段
    function updateLangFields() {
        currentLangCode = document.getElementById('language-selector').value;
        const langData = currentItem.item_lang[currentLangCode] || {};
        document.getElementById('edit-name').value = langData.name || '';
        document.getElementById('edit-seo_keywords').value = langData.seo_keywords || '';
        document.getElementById('edit-seo_description').value = langData.seo_description || '';
        document.getElementById('edit-after_sales_rules').value = langData.after_sales_rules || '';
    }

    // 保存商品
    function saveItem() {
        const itemData = {
            brand_id: parseInt(document.getElementById('edit-brand_id').value) || 0,
            services_id: parseInt(document.getElementById('edit-services_id').value) || 0,
            status: parseInt(document.getElementById('edit-status').value),
            delivery_type: parseInt(document.getElementById('edit-delivery_type').value),
            stock_quantity: parseInt(document.getElementById('edit-stock_quantity').value) || 0,
            lower_notice_quantity: parseInt(document.getElementById('edit-lower_notice_quantity').value) || 0,
            after_sales_time: parseInt(document.getElementById('edit-after_sales_time').value) || 0,
            price: parseFloat(document.getElementById('edit-price').value) || 0,
            original_price: parseFloat(document.getElementById('edit-original_price').value) || 0,
            shelf_life: parseInt(document.getElementById('edit-shelf_life').value) || 1
        };

        // 保存当前语言的多语言数据
        currentItem.item_lang[currentLangCode] = {
            name: document.getElementById('edit-name').value.trim(),
            seo_keywords: document.getElementById('edit-seo_keywords').value.trim(),
            seo_description: document.getElementById('edit-seo_description').value.trim(),
            after_sales_rules: document.getElementById('edit-after_sales_rules').value.trim()
        };

        if (!itemData.brand_id || !itemData.services_id || !currentItem.item_lang[currentLangCode].name) {
            alert('品牌、服务和商品名称不能为空！');
            return;
        }

        if (itemId) {
            // 编辑现有商品
            const index = allItems.findIndex(item => item.id == itemId);
            if (index !== -1) {
                allItems[index] = {
                    ...allItems[index],
                    ...itemData,
                    item_lang: currentItem.item_lang,
                    update_time: Math.floor(Date.now() / 1000)
                };
            }
        } else {
            // 添加新商品
            const newItem = {
                id: faker.datatype.number({ min: 1000, max: 9999 }),
                user_id: faker.datatype.number({ min: 1, max: 10000 }),
                store_id: faker.datatype.number({ min: 1000, max: 9999 }),
                ...itemData,
                sort_index: allItems.length,
                custom_url: faker.internet.url().replace(/^https?:\/\//, ''),
                cover_pic: faker.image.imageUrl(100, 100, 'product'),
                field_list: '[]',
                choose_field_index: 0,
                last_restock_time: Math.floor(Date.now() / 1000),
                create_time: Math.floor(Date.now() / 1000),
                update_time: Math.floor(Date.now() / 1000),
                item_lang: currentItem.item_lang,
                item_stat: {
                    rating: parseFloat(faker.finance.amount(1, 5, 2)),
                    comment_count: randomInt(0, 100),
                    deal_avg_count: randomInt(0, 10),
                    sellable_days: itemData.stock_quantity / randomInt(1, 10) || Infinity
                }
            };
            allItems.push(newItem);
        }

        alert('商品信息已保存！');
        window.location.href = '/site/store/item-manage.html';
    }

    // 取消编辑
    function cancelEdit() {
        window.location.href = '/site/store/item-manage.html';
    }
</script>
</body>
</html>