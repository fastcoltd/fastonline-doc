<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的需求 - FASTRESP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="../_site.css">
    <link rel="stylesheet" href="_member.css">
    <link rel="stylesheet" href="_ticket.css">
    <style>
        .demand-name {
            max-width: 20em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: inline-block;
            position: relative;
            cursor: pointer;
        }
        .demand-name:hover::after {
            content: attr(data-full);
            position: absolute;
            background: var(--bg-white);
            border: 0.0625em solid var(--border-color);
            padding: 0.5em;
            z-index: 10;
            white-space: normal;
            max-width: 25em;
            left: 0;
            top: 100%;
            box-shadow: 0 0.25em 0.5em rgba(0, 0, 0, 0.2);
        }
        .dialog {
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
        }
        .dialog-content {
            background: var(--bg-white);
            border-radius: 0.5em;
            box-shadow: 0 0.5em 1em rgba(0, 0, 0, 0.3);
            width: 90%;
            max-height: 60vw;
            max-width: 60vw;
            padding: 1.5em;
            position: relative;
        }
        .dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 0.0625em solid var(--border-color);
            padding-bottom: 0.5em;
            margin-bottom: 1em;
        }
        .dialog-header h3 {
            margin: 0;
            font-size: 1.25em;
            color: var(--font-dark);
        }
        .dialog-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--font-gray);
        }
        .dialog-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        .order-info-section {
            margin-bottom: 1.5em;
        }
        .order-info-section h4 {
            margin: 0 0 0.5em;
            color: var(--font-dark);
            font-size: 1.1em;
        }
        .order-info-content p {
            margin: 0.5em 0;
            color: var(--font-dark);
        }
        .bid-list table {
            width: 100%;
            border-collapse: collapse;
        }
        .bid-list th, .bid-list td {
            padding: 0.5em;
            border: 0.0625em solid var(--border-color);
            text-align: left;
        }
        .bid-item.winner {
            background: #e6ffe6;
            border-color: #32CD32;
        }
        .tag {
            display: inline-block;
            padding: 0.25em 0.5em;
            margin: 0.25em;
            border-radius: 0.25em;
            font-size: 0.875em;
            background: #f0f0f0;
            cursor: pointer;
        }
        .tag.selected {
            background: #32CD32;
            color: white;
        }
        #create-demand-dialog .dialog-content {
            padding: 2em;
        }
        #create-demand-dialog .order-info-section label {
            display: block;
            margin: 0.5em 0 0.2em;
            font-weight: bold;
        }
        #create-demand-dialog input, #create-demand-dialog select, #create-demand-dialog textarea {
            width: 100%;
            padding: 0.5em;
            border: 0.0625em solid var(--border-color);
            border-radius: 0.25em;
            margin-bottom: 1em;
        }
        #create-demand-dialog .attr-row {
            display: flex;
            align-items: center;
            margin-bottom: 1em;
        }
        #create-demand-dialog .attr-row select {
            width: 45%;
            margin-right: 1em;
        }
        #create-attrs {
            margin-bottom: 1em;
        }
        .btn-small {
            position: relative;
        }
    </style>
</head>
<body>
<div w3-include-html="../_header.html"></div>
<div class="member-wrapper">
    <div w3-include-html="_sidebar.html"></div>
    <div class="member-container">
        <div class="member-section">
            <h2 class="member-section-title">我的需求 <button class="btn-solid-medium" onclick="openCreateDemandModal()">发布需求</button></h2>
            <div class="orders-filter" id="demands-filter"></div>
            <table class="orders-table" id="demands-table">
                <thead id="demands-table-header"></thead>
                <tbody id="demands-table-body"></tbody>
            </table>
            <div class="pagination-controls" id="demands-pagination"></div>
        </div>
    </div>
</div>

<!-- 发布需求弹窗 -->
<div id="create-demand-dialog" class="dialog" style="display: none;">
    <div class="dialog-content">
        <div class="dialog-header">
            <h3>发布需求</h3>
            <button class="dialog-close" onclick="closeCreateDemandModal()">×</button>
        </div>
        <div class="dialog-body">
            <div class="order-info-section">
                <label>需求名称:</label>
                <input type="text" id="create-demand-name" placeholder="请输入需求名称">

                <label>品牌-服务:</label>
                <div class="attr-row">
                    <select id="create-brand-name" onchange="updateAttrValues()">
                        <option value="">选择品牌</option>
                        ${Object.keys(ecommerceAttributes).map(name => `<option value="${name}">${name}</option>`).join('')}
                    </select>
                    <select id="create-service-value">
                        <option value="">选择服务</option>
                    </select>
                </div>

                <label>价格范围 ($):</label>
                <div style="display: flex; gap: 1em;">
                    <input type="number" id="create-price-from" min="0" step="0.01" placeholder="最低价格">
                    <input type="number" id="create-price-to" min="0" step="0.01" placeholder="最高价格">
                </div>
                <label>数量 | 定金 ($):</label>
                <div style="display: flex; gap: 1em;">
                    <input type="number" id="create-quantity" min="1" placeholder="请输入数量">
                    <input type="number" id="create-deposit" min="0" step="0.01" placeholder="请输入定金">
                </div>
                <label>需要样品 | 售后服务时间 (天):</label>
                <div style="display: flex; gap: 1em;">
                    <select id="create-samples-need">
                        <option value="0">不需要</option>
                        <option value="1">需要</option>
                    </select>
                    <input type="number" id="create-after-sales-time" min="0" placeholder="请输入售后时间">
                </div>
                <label>开始时间 | 结束时间:</label>
                <div style="display: flex; gap: 1em;">
                    <input type="date" id="create-start-time">
                    <input type="date" id="create-end-time">
                </div>
                <label>属性要求:</label>
                <div class="attr-row">
                    <select id="create-attr-name" onchange="updateAttrValues()">
                        <option value="">选择属性</option>
                        ${Object.keys(ecommerceAttributes).map(name => `<option value="${name}">${name}</option>`).join('')}
                    </select>
                    <select id="create-attr-value" disabled>
                        <option value="">选择属性值</option>
                    </select>
                </div>
                <div id="create-attrs"></div>
                <label>详情:</label>
                <textarea id="create-demand-info" rows="6" placeholder="请输入需求详情"></textarea>
            </div>
            <div class="review-actions">
                <button class="btn-orange-solid-small" onclick="submitDemand()">提交</button>
            </div>
        </div>
    </div>
</div>

<!-- 查看需求弹窗 -->
<div id="view-demand-dialog" class="dialog" style="display: none;">
    <div class="dialog-content">
        <div class="dialog-header">
            <h3>需求详情</h3>
            <button class="dialog-close" onclick="closeViewDemandModal()">×</button>
        </div>
        <div class="dialog-body">
            <div class="order-info-section">
                <h4>
                    需求信息
                    <button class="btn-small" onclick="openLogsModal()" style="position: absolute;right: 10em;margin-bottom: 0.5em;top: 8em;"><i class="fa fa-history"></i> 查看日志</button>
                    <button class="btn-red-solid-small" style="position: absolute;right: 3em;margin-bottom: 0.5em;top: 8em;"><i class="fa fa-times"></i> 关闭需求(仅未开始投标可关闭)</button>
                </h4>
                <div id="view-demand-info" class="order-info-content"></div>
                <div id="view-demand-bid" class="order-info-content" style="display: none;"></div>
                <div id="view-demand-actions" class="review-actions"></div>
            </div>
            <div class="order-info-section" id="view-winner-section" style="display: none;">
                <h4>中标者</h4>
                <div id="view-winner-info" class="bid-item winner"></div>
            </div>
            <div class="order-info-section bid-list" id="view-bid-list" style="display: none;">
                <h4>竞标列表</h4>
                <table>
                    <thead>
                    <tr>
                        <th>投标者</th>
                        <th>投标价格 ($)</th>
                        <th>样品数</th>
                        <th>图片</th>
                        <th>投标时间</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="view-bids"></tbody>
                </table>
                <div class="pagination-controls" id="bids-pagination"></div>
            </div>
        </div>
    </div>
</div>

<!-- 竞标详情弹窗 -->
<div id="bid-detail-dialog" class="dialog" style="display: none;">
    <div class="dialog-content">
        <div class="dialog-header">
            <h3>竞标详情</h3>
            <button class="dialog-close" onclick="closeBidDetailModal()">×</button>
        </div>
        <div class="dialog-body">
            <div id="bid-detail-info" class="order-info-content"></div>
        </div>
    </div>
</div>

<!-- 操作日志弹窗 -->
<div id="logs-dialog" class="dialog" style="display: none;">
    <div class="dialog-content">
        <div class="dialog-header">
            <h3>操作日志</h3>
            <button class="dialog-close" onclick="closeLogsModal()">×</button>
        </div>
        <div class="dialog-body">
            <table class="orders-table" id="logs-table">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>用户名</th>
                    <th>店铺名</th>
                    <th>日志</th>
                    <th>时间</th>
                </tr>
                </thead>
                <tbody id="logs-table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<div w3-include-html="../_footer.html"></div>
<script src="https://www.w3schools.com/lib/w3.js"></script>
<script src="https://cdn.jsdelivr.net/npm/faker@5.5.3/dist/faker.min.js"></script>
<script src="../_location.js"></script>
<script src="../_common.js"></script>
<script src="../_member.js"></script>
<script src="_mCommon.js"></script>
<script src="_ticket.js"></script>
<script src="../_fields.js"></script>
<script src="../_data.js"></script>
<script>
    const redDotState = {};
    const statusMap = {
        0: 'Drafts',
        1: '审核中',
        2: '审核拒绝',
        3: '审核通过',
        4: '等待开始',
        5: 'Bidding',
        6: 'Bid Won',
        7: 'Rest Paid',
        8: 'Delivered',
        9: '已确认收货',
        10: 'Canceled',
        11: 'Expired',
    };

    // 字段配置
    const demandsConfig = {
        id: { label: 'ID', format: v => v },
        demand_name: {
            label: '需求名称',
            format: (v, item) => `<a href="/site/demand.html?name=${v}" class="demand-name" data-full="${v}">${v}</a>`
        },
        brand_id: { label: '品牌', format: v => {
                return `${generateBrand()}`
        }},
        service_id: { label: '服务', format: v => {
                return `${generateServices()}`
        }},
        quantity: { label: '数量', format: v => v },
        price: {
            label: '出价($)',
            format: (v, item) => `${item.price_to.toFixed(2)}`
        },
        deposit: { label: '定金($)', format: v => v.toFixed(2) },
        bid_count: { label: '投标数', format: v => v <= 0 ? '无' : `<span style="color: red">${v}</span>人` },
        status: {
            label: '状态',
            format: v => `<span style="color: ${demandStatusColors[statusMap[v]] || '#A9A9A9'}">${statusMap[v]}</span>`
        },
        // attrs: {
        //     label: '属性要求',
        //     format: (v, item) => item.attrs.map(attr => `<span class="ant-tag ${tagColors[Math.floor(Math.random() * tagColors.length)]}">${attr.name}: ${attr.value}</span>`).join('')
        // },
        // paid_rest_money: { label: '尾款($)', format: v => v ? v.toFixed(2) : '未支付' },
        create_time: { label: '时间', format: v => v },
        operation: {
            label: '操作',
            format: (v, item) => {
                let buttons = '';
                // Always include the "查看" button
                const hasRedDot = item.status >= 5 && Math.random() < 0.5 && !redDotState[item.id];

                // Add other buttons based on status
                if (item.status === 0) buttons += `<button class="btn-small btn-solid-medium" onclick="submitDemandForReview(${item.id})">提交审核</button>`;
                if (item.status === 2) buttons += `<button class="btn-small btn-solid-medium" onclick="editDemands(${item.id})">编辑</button>`;
                if (item.status === 3) buttons += `<button class="btn-orange-solid-small" onclick="payDeposit(${item.id})">支付定金</button>`;
                // if (item.status === 6) buttons += `<button class="btn-small btn-orange-solid-small" onclick="payRestMoney(${item.id})">支付尾款</button>`;
                if (item.status > 8) buttons += `<button class="btn-small btn-red-solid-small" onclick="refusedDemands(${item.id})">验收失败</button><button class="btn-solid-small" onclick="confirmDemands(${item.id})">验收通过</button>`;
                if (item.status === 9) buttons += `<button class="btn-solid-small" onclick="reviewDemand(${item.id})"><i class="fa fa-star"></i> 评价</button>`;

                buttons += `
                    <button class="btn-small" onclick="viewDemand(${item.id}); removeRedDot(${item.id})">
                        <i class="fa fa-eye"></i> View
                        ${hasRedDot ? '<span class="red-dot"></span>' : ''}
                    </button>`;

                return `<div class="operation-area">${buttons}</div>`;
            }
        }
    };

    function removeRedDot(demandId) {
        redDotState[demandId] = true; // Mark this demand as having its red dot removed
        renderTableBody(); // Re-render the table to reflect the change
    }

    // 分页和数据管理
    let currentPage = 1;
    let pageSize = pageConfig.find(p => p.selected).page;
    let filteredDemands = [];
    const allDemands = Array(randomInt(50, 500)).fill().map(() => {
        const demand = {
            id: faker.datatype.number({ min: 1000, max: 999999 }),
            status: faker.datatype.number({ min: 0, max: 10 }),
            user_id: faker.datatype.number({ min: 1, max: 1000 }),
            brand_id: faker.datatype.number({ min: 1, max: 100 }),
            services_id: faker.datatype.number({ min: 1, max: 50 }),
            price_from: faker.datatype.float({ min: 10, max: 100, precision: 0.01 }),
            price_to: faker.datatype.float({ min: 100, max: 1000, precision: 0.01 }),
            quantity: faker.datatype.number({ min: 1, max: 100 }),
            deposit: faker.datatype.float({ min: 0, max: 50, precision: 0.01 }),
            samples_need: faker.datatype.number({ min: 0, max: 1 }),
            after_sales_time: faker.datatype.number({ min: 0, max: 365 }),
            start_time: Math.floor(faker.date.soon().getTime() / 1000),
            end_time: Math.floor(faker.date.future().getTime() / 1000),
            paid_rest_money: Math.random() > 0.5 ? faker.datatype.float({ min: 50, max: 500, precision: 0.01 }) : 0,
            paid_time: Math.random() > 0.5 ? Math.floor(faker.date.recent().getTime() / 1000) : 0,
            choose_store_id: Math.random() > 0.5 ? faker.datatype.number({ min: 1, max: 1000 }) : 0,
            choose_unit_price: Math.random() > 0.5 ? faker.datatype.float({ min: 10, max: 100, precision: 0.01 }) : 0,
            choose_time: Math.random() > 0.5 ? Math.floor(faker.date.recent().getTime() / 1000) : 0,
            amount: faker.datatype.float({ min: 50, max: 1000, precision: 0.01 }),
            create_time: faker.date.recent().toLocaleString(),
            confirm_time: Math.floor(faker.date.recent().getTime() / 1000)
        };
        demand.demand_name = faker.commerce.productName();
        demand.attrs = Array(faker.datatype.number({ min: 1, max: 3 })).fill().map(() => {
            const attrName = Object.keys(ecommerceAttributes)[Math.floor(Math.random() * Object.keys(ecommerceAttributes).length)];
            const attrValues = ecommerceAttributes[attrName];
            return { name: attrName, value: attrValues[Math.floor(Math.random() * attrValues.length)] };
        });
        demand.bid_count = faker.datatype.number({ min: 0, max: 15 });
        return demand;
    });

    const allBids = allDemands.filter(d => d.status >= 5).map(d =>
        Array(randomInt(3, 30)).fill().map(() => ({
            id: faker.datatype.number({ min: 1000, max: 999999 }),
            demand_id: d.id,
            user_id: faker.datatype.number({ min: 1, max: 1000 }),
            store_id: faker.datatype.number({ min: 1, max: 1000 }),
            status: d.choose_store_id === faker.datatype.number({ min: 1, max: 1000 }) ? 1 : 0,
            bid_time: Math.floor(faker.date.recent().getTime() / 1000),
            bid_price: faker.datatype.float({ min: d.price_from, max: d.price_to, precision: 0.01 }),
            bid_information: faker.lorem.sentence(),
            bid_pics: JSON.stringify(
                Array(randomInt(1, 3)).fill().map(() => getPicsumImage(50, 50, `bidder-${Math.random()}`))
            ),
            bid_win_time: d.choose_store_id === faker.datatype.number({ min: 1, max: 1000 }) ? Math.floor(faker.date.recent().getTime() / 1000) : 0,
            sample_list: JSON.stringify(
                Array(randomInt(1, 3)).fill().map(() => fieldsList.sort(() => 0.2 - Math.random()).slice(0, Math.floor(Math.random() * 6) + 3).join("----"))
            )
        }))
    ).flat();
    // 日志数据生成（1-50 条）
    const allLogs = allDemands.map(d =>
        Array(randomInt(1, 50)).fill().map(() => ({
            id: faker.datatype.number({ min: 1000, max: 999999 }),
            demand_id: d.id,
            user_id: faker.datatype.number({ min: 1, max: 1000 }),
            store_id: faker.datatype.number({ min: 1, max: 1000 }) || 0,
            username: faker.internet.userName(),
            store_name: faker.company.companyName(),
            log: [
                `${faker.internet.userName()} 发布了需求`,
                `${faker.internet.userName()} 支付了定金`,
                `${faker.internet.userName()} 提交了投标`,
                `${faker.internet.userName()} 提交了评论`,
                '需求通过审核',
                `需求被拒绝 (原因: ${faker.lorem.sentence()})`
            ][Math.floor(Math.random() * 6)],
            create_time: Math.floor(faker.date.recent().getTime() / 1000)
        }))
    ).flat();

    // 日志分页显示
    let logsPage = 1;
    const logsPageSize = 10;

    function openLogsModal() {
        const logs = allLogs.filter(l => l.demand_id === currentViewId);
        const start = (logsPage - 1) * logsPageSize;
        const end = start + logsPageSize;
        const paginatedLogs = logs.slice(start, end);
        const body = document.getElementById('logs-table-body');
        body.innerHTML = paginatedLogs.map(log => {
            let showUser = randomInt(0,1) > 0
            return `<tr style="white-space: nowrap;">
                <td>${log.id}</td>
                <td>${showUser ? log.username : '--'}</td>
                <td>${!showUser ? log.store_name : '--'}</td>
                <td>${log.log}</td>
                <td>${new Date(log.create_time * 1000).toLocaleString()}</td>
            </tr>
            `
        }).join('');

        const totalLogsPages = Math.ceil(logs.length / logsPageSize);
        const paginationDiv = document.createElement('div');
        paginationDiv.className = 'pagination-controls';
        paginationDiv.innerHTML = `
            <button class="btn-small pagination-btn" onclick="changeLogsPage(${logsPage - 1})" ${logsPage === 1 ? 'disabled' : ''}>上一页</button>
            <span>第 ${logsPage} 页 / 共 ${totalLogsPages} 页</span>
            <button class="btn-small pagination-btn" onclick="changeLogsPage(${logsPage + 1})" ${logsPage === totalLogsPages ? 'disabled' : ''}>下一页</button>
        `;
        document.getElementById('logs-dialog').querySelector('.dialog-body').appendChild(paginationDiv);
        document.getElementById('logs-dialog').style.display = 'flex';
    }

    function changeLogsPage(newPage) {
        const logs = allLogs.filter(l => l.demand_id === currentViewId);
        const totalLogsPages = Math.ceil(logs.length / logsPageSize);
        if (newPage >= 1 && newPage <= totalLogsPages) {
            logsPage = newPage;
            openLogsModal();
        }
    }

    function closeLogsModal() {
        document.getElementById('logs-dialog').style.display = 'none';
        logsPage = 1; // 重置分页
    }

    function initDemandsPage() {
        filteredDemands = [...allDemands];
        renderFilterForm();
        renderTableHeader();
        renderTableBody();
        renderPagination();
    }

    function renderFilterForm() {
        const filterDiv = document.getElementById('demands-filter');
        filterDiv.innerHTML = `
            <input type="text" id="filter-search" placeholder="需求名称">
            <select id="filter-status">
                <option value="">状态</option>
                ${Object.entries(statusMap).map(([k, v]) => `<option value="${k}">${v}</option>`).join('')}
            </select>
            <input type="date" id="filter-date-start" placeholder="开始日期"> ~ <input type="date" id="filter-date-end" placeholder="结束日期">
            <button class="btn-solid-medium" onclick="applyFilters()">查询</button>
            <button class="btn-orange-medium" onclick="resetFilters()">重置</button>
        `;
    }

    function applyFilters() {
        const search = document.getElementById('filter-search').value.toLowerCase();
        const status = document.getElementById('filter-status').value;
        const dateStart = document.getElementById('filter-date-start').value;
        const dateEnd = document.getElementById('filter-date-end').value;

        filteredDemands = allDemands.filter(demand => {
            let match = true;
            if (search && !demand.demand_name.toLowerCase().includes(search)) match = false;
            if (status !== '' && demand.status.toString() !== status) match = false;
            if (dateStart && demand.start_time < Math.floor(new Date(dateStart).getTime() / 1000)) match = false;
            if (dateEnd && demand.start_time > Math.floor(new Date(dateEnd).getTime() / 1000)) match = false;
            return match;
        });

        currentPage = 1;
        renderTableBody();
        renderPagination();
    }

    function resetFilters() {
        document.getElementById('filter-search').value = '';
        document.getElementById('filter-status').value = '';
        document.getElementById('filter-date-start').value = '';
        document.getElementById('filter-date-end').value = '';
        filteredDemands = [...allDemands];
        currentPage = 1;
        renderTableBody();
        renderPagination();
    }

    function renderTableHeader() {
        const header = document.getElementById('demands-table-header');
        header.innerHTML = '<tr>' + Object.entries(demandsConfig)
            .map(([_, config]) => `<th>${config.label}</th>`).join('') + '</tr>';
    }

    function renderTableBody() {
        const body = document.getElementById('demands-table-body');
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const paginatedDemands = filteredDemands.slice(start, end);
        body.innerHTML = paginatedDemands.map(demand => `
            <tr>
                ${Object.entries(demandsConfig).map(([key, config]) => {
            const value = demand[key];
            const formatFn = config.format || (v => v);
            const formattedValue = key === 'operation' || key === 'demand_name' || key === 'attrs' || key === 'price' ? formatFn(value, demand) : formatFn(value);
            return `<td>${formattedValue}</td>`;
        }).join('')}
            </tr>
        `).join('');
    }

    function renderPagination() {
        let pageOptions = `<select id="page-size" onchange="changePageSize()">`;
        pageConfig.forEach(item => {
            pageOptions += `<option value="${item.page}" ${item.page === pageSize ? 'selected' : ''}>${item.page}条/页</option>`;
        });
        pageOptions += `</select>`;

        const totalPages = Math.ceil(filteredDemands.length / pageSize);
        const paginationDiv = document.getElementById('demands-pagination');
        paginationDiv.innerHTML = `
            <button class="btn-small pagination-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>上一页</button>
            <span>第 ${currentPage} 页 / 共 ${totalPages} 页</span>
            <button class="btn-small pagination-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>下一页</button>
            <div class="pagination-options">
                ${pageOptions}
                <input type="number" id="jump-page" min="1" max="${totalPages}" placeholder="页">
                <button class="btn-small" onclick="jumpToPage()">跳转</button>
            </div>
        `;
    }

    function changePage(newPage) {
        const totalPages = Math.ceil(filteredDemands.length / pageSize);
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderTableBody();
            renderPagination();
        }
    }

    function changePageSize() {
        pageSize = parseInt(document.getElementById('page-size').value);
        currentPage = 1;
        renderTableBody();
        renderPagination();
    }

    function jumpToPage() {
        const totalPages = Math.ceil(filteredDemands.length / pageSize);
        const page = parseInt(document.getElementById('jump-page').value);
        if (page >= 1 && page <= totalPages) {
            currentPage = page;
            renderTableBody();
            renderPagination();
        }
    }

    // 发布需求
    let selectedAttrs = [];
    function openCreateDemandModal() {
        selectedAttrs = [];
        document.getElementById('create-demand-name').value = '';
        document.getElementById('create-price-from').value = '';
        document.getElementById('create-price-to').value = '';
        document.getElementById('create-quantity').value = '';
        document.getElementById('create-deposit').value = '';
        document.getElementById('create-samples-need').value = '0';
        document.getElementById('create-after-sales-time').value = '';
        document.getElementById('create-start-time').value = '';
        document.getElementById('create-end-time').value = '';
        document.getElementById('create-demand-info').value = '';
        document.getElementById('create-attr-name').value = '';
        document.getElementById('create-attr-value').innerHTML = '<option value="">选择属性值</option>';
        document.getElementById('create-attr-value').disabled = true;
        document.getElementById('create-attrs').innerHTML = '';
        document.getElementById('create-demand-dialog').style.display = 'flex';
    }

    function closeCreateDemandModal() {
        document.getElementById('create-demand-dialog').style.display = 'none';
    }

    function openCreateDemandModal() {
        selectedAttrs = [];
        document.getElementById('create-demand-name').value = '';
        document.getElementById('create-price-from').value = '';
        document.getElementById('create-price-to').value = '';
        document.getElementById('create-quantity').value = '';
        document.getElementById('create-deposit').value = '';
        document.getElementById('create-samples-need').value = '0';
        document.getElementById('create-after-sales-time').value = '';
        document.getElementById('create-start-time').value = '';
        document.getElementById('create-end-time').value = '';
        document.getElementById('create-demand-info').value = '';
        document.getElementById('create-attr-name').value = '';
        document.getElementById('create-attr-value').innerHTML = '<option value="">选择属性值</option>';
        document.getElementById('create-attr-value').disabled = true;
        document.getElementById('create-attrs').innerHTML = '';
        document.getElementById('create-demand-dialog').style.display = 'flex';

        let brandOptions = `${hotBrands.map(b => `<option value="${b.name}" style="color: ${b.themeColor};">${b.name}</option>`).join('')}`
        let serversOptions = `${services.map(s => `<option value="${s.name}">${s.name}</option>`).join('')}`
        document.getElementById('create-brand-name').innerHTML = brandOptions;
        document.getElementById('create-service-value').innerHTML = serversOptions;
    }

    function updateAttrValues() {
        const attrName = document.getElementById('create-attr-name').value;
        const attrValueSelect = document.getElementById('create-attr-value');
        attrValueSelect.innerHTML = '<option value="">选择属性值</option>';
        if (attrName && ecommerceAttributes[attrName]) { // 检查属性是否存在
            const availableValues = ecommerceAttributes[attrName].filter(val =>
                !selectedAttrs.some(attr => attr.name === attrName && attr.value === val)
            );
            availableValues.forEach(val => {
                const option = document.createElement('option');
                option.value = val;
                option.text = val;
                attrValueSelect.appendChild(option);
            });
            attrValueSelect.disabled = false;
        } else {
            attrValueSelect.disabled = true;
        }
    }

    function addAttrTag() {
        const attrName = document.getElementById('create-attr-name').value;
        const attrValue = document.getElementById('create-attr-value').value;
        if (attrName && attrValue && !selectedAttrs.some(attr => attr.name === attrName && attr.value === attrValue)) {
            selectedAttrs.push({ name: attrName, value: attrValue });
            renderAttrTags();
            document.getElementById('create-attr-name').value = '';
            updateAttrValues();
        }
    }

    document.getElementById('create-attr-value').addEventListener('change', () => {
        const attrName = document.getElementById('create-attr-name').value;
        const attrValue = document.getElementById('create-attr-value').value;
        if (attrName && attrValue && !selectedAttrs.some(attr => attr.name === attrName && attr.value === attrValue)) {
            selectedAttrs.push({ name: attrName, value: attrValue });
            renderAttrTags();
            document.getElementById('create-attr-name').value = '';
            updateAttrValues();
        }
    });

    function renderAttrTags() {
        const attrsDiv = document.getElementById('create-attrs');
        attrsDiv.innerHTML = selectedAttrs.map(attr => `
            <span class="tag" onclick="removeAttrTag('${attr.name}', '${attr.value}')">${attr.name}: ${attr.value} <i class="fa fa-times"></i></span>
        `).join('');
    }


    function submitDemand() {
        const demandName = document.getElementById('create-demand-name').value.trim();
        const priceFrom = parseFloat(document.getElementById('create-price-from').value);
        const priceTo = parseFloat(document.getElementById('create-price-to').value);
        const quantity = parseInt(document.getElementById('create-quantity').value);
        const deposit = parseFloat(document.getElementById('create-deposit').value);
        const samplesNeed = parseInt(document.getElementById('create-samples-need').value);
        const afterSalesTime = parseInt(document.getElementById('create-after-sales-time').value);
        const startTime = Math.floor(new Date(document.getElementById('create-start-time').value).getTime() / 1000);
        const endTime = Math.floor(new Date(document.getElementById('create-end-time').value).getTime() / 1000);
        const demandInfo = document.getElementById('create-demand-info').value.trim();

        if (!demandName || isNaN(priceFrom) || isNaN(priceTo) || isNaN(quantity) || isNaN(deposit) ||
            isNaN(samplesNeed) || isNaN(afterSalesTime) || isNaN(startTime) || isNaN(endTime) || !demandInfo || selectedAttrs.length === 0) {
            alert('请填写所有必填字段并至少选择一个属性要求');
            return;
        }

        const newDemand = {
            id: Math.max(...allDemands.map(d => d.id)) + 1,
            status: 0,
            user_id: 1, // 假设当前用户
            brand_id: 0,
            services_id: 0,
            price_from: priceFrom,
            price_to: priceTo,
            quantity,
            deposit,
            samples_need: samplesNeed,
            after_sales_time: afterSalesTime,
            start_time: startTime,
            end_time: endTime,
            paid_rest_money: 0,
            paid_time: 0,
            choose_store_id: 0,
            choose_unit_price: 0,
            choose_time: 0,
            amount: 0,
            create_time: Math.floor(Date.now() / 1000),
            confirm_time: 0,
            demand_name: demandName,
            attrs: selectedAttrs,
            bid_count: 0,
            demand_information: demandInfo
        };
        allDemands.push(newDemand);
        filteredDemands = [...allDemands];
        allLogs.push({
            id: Math.max(...allLogs.map(l => l.id)) + 1,
            demand_id: newDemand.id,
            user_id: newDemand.user_id,
            store_id: 0,
            username: faker.internet.userName(),
            store_name: '',
            log: `${faker.internet.userName()} 发布了需求`,
            create_time: Math.floor(Date.now() / 1000)
        });
        renderTableBody();
        renderPagination();
        closeCreateDemandModal();
        console.log('新需求已创建:', newDemand);
    }

    // 操作函数
    function submitDemandForReview(id) {
        const demand = allDemands.find(d => d.id === id);
        if (demand && demand.status === 0) {
            demand.status = 3;
            filteredDemands = filteredDemands.map(d => d.id === id ? demand : d);
            allLogs.push({
                id: Math.max(...allLogs.map(l => l.id)) + 1,
                demand_id: id,
                user_id: demand.user_id,
                store_id: 0,
                username: faker.internet.userName(),
                store_name: '',
                log: '需求提交审核',
                create_time: Math.floor(Date.now() / 1000)
            });
            renderTableBody();
            console.log(`需求 ID: ${id} 已提交审核`);
        }
    }
    function editDemands(id) {
        const demand = allDemands.find(d => d.id === id);
        if (demand && demand.status === 2) {
            demand.status = 1;
            filteredDemands = filteredDemands.map(d => d.id === id ? demand : d);
            allLogs.push({
                id: Math.max(...allLogs.map(l => l.id)) + 1,
                demand_id: id,
                user_id: demand.user_id,
                store_id: 0,
                username: faker.internet.userName(),
                store_name: '',
                log: '编辑',
                create_time: Math.floor(Date.now() / 1000)
            });
            openCreateDemandModal()
        }
    }

    function payDeposit(id) {
        const demand = allDemands.find(d => d.id === id);
        if (demand && demand.status === 3 && confirm('确认要支付定金吗？')) {
            demand.paid_rest_money = demand.amount - demand.deposit;
            demand.paid_time = Math.floor(Date.now() / 1000);
            demand.status = 4;
            filteredDemands = filteredDemands.map(d => d.id === id ? demand : d);
            allLogs.push({
                id: Math.max(...allLogs.map(l => l.id)) + 1,
                demand_id: id,
                user_id: demand.user_id,
                store_id: demand.choose_store_id,
                username: faker.internet.userName(),
                store_name: faker.company.companyName(),
                log: `${faker.internet.userName()} 支付了定金`,
                create_time: Math.floor(Date.now() / 1000)
            });
            renderTableBody();
            console.log(`需求 ID: ${id} 已支付定金`);
        }
    }

    function payRestMoney(id) {
        const demand = allDemands.find(d => d.id === id);
        if (demand && demand.status === 6 && confirm('确认要支付尾款吗？')) {
            demand.paid_rest_money = demand.amount - demand.deposit;
            demand.paid_time = Math.floor(Date.now() / 1000);
            demand.status = 7;
            filteredDemands = filteredDemands.map(d => d.id === id ? demand : d);
            allLogs.push({
                id: Math.max(...allLogs.map(l => l.id)) + 1,
                demand_id: id,
                user_id: demand.user_id,
                store_id: demand.choose_store_id,
                username: faker.internet.userName(),
                store_name: faker.company.companyName(),
                log: `${faker.internet.userName()} 支付了尾款`,
                create_time: Math.floor(Date.now() / 1000)
            });
            renderTableBody();
            console.log(`需求 ID: ${id} 已支付尾款`);
        }
    }

    function confirmDemands(id) {
        const demand = allDemands.find(d => d.id === id);
        if (demand && demand.status === 8 && confirm('确认 通过验收 吗？')) {
            demand.paid_rest_money = demand.amount - demand.deposit;
            demand.paid_time = Math.floor(Date.now() / 1000);
            demand.status++;
            filteredDemands = filteredDemands.map(d => d.id === id ? demand : d);
            allLogs.push({
                id: Math.max(...allLogs.map(l => l.id)) + 1,
                demand_id: id,
                user_id: demand.user_id,
                store_id: demand.choose_store_id,
                username: faker.internet.userName(),
                store_name: faker.company.companyName(),
                log: `${faker.internet.userName()} 通过验收`,
                create_time: Math.floor(Date.now() / 1000)
            });
            renderTableBody();
            console.log(`需求 ID: ${id} 完成验收确认`);
        }
    }

    function refusedDemands(id) {
        const demand = allDemands.find(d => d.id === id);
        if (demand && demand.status === 8 && confirm('确认 未通过验收 吗？')) {
            demand.paid_rest_money = demand.amount - demand.deposit;
            demand.paid_time = Math.floor(Date.now() / 1000);
            filteredDemands = filteredDemands.map(d => d.id === id ? demand : d);
            allLogs.push({
                id: Math.max(...allLogs.map(l => l.id)) + 1,
                demand_id: id,
                user_id: demand.user_id,
                store_id: demand.choose_store_id,
                username: faker.internet.userName(),
                store_name: faker.company.companyName(),
                log: `${faker.internet.userName()} 未通过验收`,
                create_time: Math.floor(Date.now() / 1000)
            });
            renderTableBody();
            alert(`需求 ID: ${id} 未通过验收 确认， 进入创建工单流程。`);
        }
    }

    function reviewDemand(id) {
        alert('评价功能待实现，参考 orders.html 中的评价逻辑');
    }

    // 查看需求
    let currentViewId = null;
    let bidsPage = 1;
    const bidsPageSize = 10;

    function viewDemand(id) {
        const demand = allDemands.find(d => d.id === id);
        if (!demand) return;

        currentViewId = id;
        const bids = allBids.filter(b => b.demand_id === id && demand.status < 6);
        // 如果状态为 Bid Won (6)，随机选择一个中标者
        let winner;
        if (demand.status >= 6) {
            const eligibleBids = allBids.filter(b => b.demand_id === id);
            winner = eligibleBids[Math.floor(Math.random() * eligibleBids.length)];
            if (!demand.choose_store_id && winner) {
                demand.choose_store_id = winner.store_id;
            }
        } else {
            winner = bids.find(b => b.store_id === demand.choose_store_id);
        }
        const badge = generateBadge('Store', 0, 1);

        document.getElementById('view-demand-info').innerHTML = `
            <p>需求名称: ${demand.demand_name}</p>
            <p>需求ID: ${demand.id} | 状态: <span style="color: ${demandStatusColors[statusMap[demand.status]] || '#A9A9A9'}">${statusMap[demand.status]}</span> | 数量: ${demand.quantity} | 定金: $${demand.deposit.toFixed(2)} | 尾款: $${demand.paid_rest_money ? demand.paid_rest_money.toFixed(2) : '未支付'} | 需要样品: ${demand.samples_need ? '是' : '否'} | 售后天数: ${demand.after_sales_time}</p>
            <p>价格范围: $${demand.price_from.toFixed(2)} - $${demand.price_to.toFixed(2)} | 开始时间: ${new Date(demand.start_time * 1000).toLocaleString()} | 结束时间: ${new Date(demand.end_time * 1000).toLocaleString()}</p>
            <p>属性要求: ${demand.attrs.map(attr => `<span class="ant-tag ${tagColors[Math.floor(Math.random() * tagColors.length)]}">${attr.name}: ${attr.value}</span>`).join('')}</p>
            <p>需求详情: ${demand.demand_information || '暂无'}</p>
        `;

        let winnerElement = document.getElementById('view-demand-bid');
        winnerElement.style.display = 'none'
        if (winner){
            let winnerStoreName = faker.company.companyName()
            const  winnerHtml = winner ? `
                <div class="order-info-section" style="background: #f9f9f9; border-radius: 0.25em;">
                    <h4>中标者信息</h4>
                    <p style="white-space: nowrap;">
                        <img src="${getPicsumImage(30, 30, `store-${winner.store_id}`)}" alt="店铺头像" style="width: 30px; height: 30px; border-radius: 50%; vertical-align: middle; margin-right: 0.5em;">
                        <a href="/site/store.html?name=${winnerStoreName}">${winnerStoreName} (${winner.store_id})</a>
                        ${Array(Math.floor(Math.random() * 5) + 1).fill('<i class="fa fa-star" style="color: #FFD700;"></i>').join('')}
                        ${Array(5 - Math.floor(Math.random() * 5) - 1).fill('<i class="fa fa-star-o" style="color: #FFD700;"></i>').join('')}
                        ${badge}
                    </p>
                    <p>竞标价格: $${winner.bid_price.toFixed(2)} | 竞标时间: ${new Date(winner.bid_time * 1000).toLocaleString()}</p>
                    <p>竞标信息: ${winner.bid_information}</p>
                    <p>样品列表:  <a href="#" class="btn-small">复制</a></p>
                    <p>${JSON.parse(winner.sample_list).map(s => s).join('</p><p>')}</p>
                    <p>图片: ${JSON.parse(winner.bid_pics).map(p => `<img src="${p}" alt="Bid Pic" style="width: 100px;">`).join('')}</p>
                    ${demand.status === 6 ? `<button class="btn-small btn-orange-solid-small" onclick="payRestMoney(${id})">支付尾款 $${(randomInt(100, 1000)/100).toFixed(2)}</button>` : ''}
                </div>
            ` : demand.status >= 6 ? '<p>未找到投标记录，无法选择中标者</p>' : ''
            winnerElement.innerHTML = winnerHtml
            winnerElement.style.display = 'block'
        }

        let actions = '';
        if (demand.status >= 7) actions += `<button class="btn-small" onclick="downloadBids(${id})"><i class="fa fa-download"></i> 下载所有数据</button>`;
        document.getElementById('view-demand-actions').innerHTML = actions;

        if (winner) {
            document.getElementById('view-winner-section').style.display = 'none';
        } else {
            document.getElementById('view-winner-section').style.display = 'none';
        }

        if (bids.length > 0 && demand.status < 6) {
            document.getElementById('view-bid-list').style.display = 'block';
            renderBids(bids);
        } else {
            document.getElementById('view-bid-list').style.display = 'none';
        }

        document.getElementById('view-demand-dialog').style.display = 'flex';
    }

    function closeViewDemandModal() {
        document.getElementById('view-demand-dialog').style.display = 'none';
        currentViewId = null;
    }

    function renderBids(bids) {
        const start = (bidsPage - 1) * bidsPageSize;
        const end = start + bidsPageSize;
        const paginatedBids = bids.slice(start, end);
        const bidsDiv = document.getElementById('view-bids');
        bidsDiv.innerHTML = paginatedBids.map(bid => {
            const storeName = faker.company.companyName();
            const rating = Math.floor(Math.random() * 5) + 1;
            const ratingCount = randomInt(1, 500);
            const verified = randomInt(0, 1) > 0
            const badge = generateBadge('Store', 0, 1);
            const deposit = randomInt(500, 5000);
            return `
            <tr>
                <td style="white-space: nowrap;">
                    <img src="${getPicsumImage(30, 30, `store-${bid.store_id}`)}" alt="店铺头像" style="width: 30px; height: 30px; border-radius: 50%; vertical-align: middle; margin-right: 0.2em;">
                    <i class="fas fa-check-circle" style="color: ${verified ? 'var(--font-green)' : ''}"></i> <a href="/site/store.html?name=${storeName}" target="_blank"> ${storeName}</a> |
                    <i class="fas fa-shield-alt"></i><b title="deposit of store" style="color: var(--font-orange)"> $${deposit}</b> |
                    ${Array(rating).fill('<i class="fa fa-star" style="color: #FFD700;"></i>').join('')}
                    ${Array(5 - rating).fill('<i class="fa fa-star-o" style="color: #FFD700;"></i>').join('')}(${ratingCount})
                    ${badge}
                </td>
                <td>$${bid.bid_price.toFixed(2)}</td>
                <td>${randomInt(0, 5)}</td>
                <td>${randomInt(0, 3)}</td>
                <td>${new Date(bid.bid_time * 1000).toLocaleString()}</td>
                <td>
                    <button class="btn-small" onclick="viewBidDetail(${bid.id})">查看详情</button>
                    ${allDemands.find(d => d.id === currentViewId)?.status === 5 ? `<button class="btn-small btn-orange-solid-small" onclick="selectBid(${bid.id})">选中+支付尾款</button>` : ''}
                </td>
            </tr>
        `;
        }).join('');

        const totalBidsPages = Math.ceil(bids.length / bidsPageSize);
        document.getElementById('bids-pagination').innerHTML = `
        <button class="btn-small pagination-btn" onclick="changeBidsPage(${bidsPage - 1})" ${bidsPage === 1 ? 'disabled' : ''}>上一页</button>
        <span>第 ${bidsPage} 页 / 共 ${totalBidsPages} 页</span>
        <button class="btn-small pagination-btn" onclick="changeBidsPage(${bidsPage + 1})" ${bidsPage === totalBidsPages ? 'disabled' : ''}>下一页</button>
    `;
    }

    function changeBidsPage(newPage) {
        const bids = allBids.filter(b => b.demand_id === currentViewId && allDemands.find(d => d.id === currentViewId).status < 6);
        const totalBidsPages = Math.ceil(bids.length / bidsPageSize);
        if (newPage >= 1 && newPage <= totalBidsPages) {
            bidsPage = newPage;
            renderBids(bids);
        }
    }

    function viewBidDetail(bidId) {
        const bid = allBids.find(b => b.id === bidId);
        if (!bid) return;

        document.getElementById('bid-detail-info').innerHTML = `
            <p>店铺ID: ${bid.store_id} | 竞标价格: $${bid.bid_price.toFixed(2)} | 竞标时间: ${new Date(bid.bid_time * 1000).toLocaleString()}</p>
            <p>竞标信息: ${bid.bid_information}</p>
            <p>样品列表:  <a href="#" class="btn-small">复制</a></p>
            <p>${JSON.parse(bid.sample_list).map(s => s).join('</p><p>')}</p>
            <p>图片: ${JSON.parse(bid.bid_pics).map(p => `<img src="${p}" alt="Bid Pic" style="width: 100px;">`).join('')}</p>
        `;
        document.getElementById('bid-detail-dialog').style.display = 'flex';
    }

    function closeBidDetailModal() {
        document.getElementById('bid-detail-dialog').style.display = 'none';
    }

    function selectBid(bidId) {
        const demand = allDemands.find(d => d.id === currentViewId);
        const bid = allBids.find(b => b.id === bidId);
        if (demand && bid && demand.status === 5 && confirm('确认选中此竞标者吗？')) {
            demand.choose_store_id = bid.store_id;
            demand.choose_unit_price = bid.bid_price;
            demand.choose_time = Math.floor(Date.now() / 1000);
            demand.status = 8;
            bid.status = 1;
            filteredDemands = filteredDemands.map(d => d.id === currentViewId ? demand : d);
            allLogs.push({
                id: Math.max(...allLogs.map(l => l.id)) + 1,
                demand_id: demand.id,
                user_id: demand.user_id,
                store_id: bid.store_id,
                username: faker.internet.userName(),
                store_name: faker.company.companyName(),
                log: `${faker.internet.userName()} 选中了店铺 ${bid.store_id}`,
                create_time: Math.floor(Date.now() / 1000)
            });
            viewDemand(currentViewId);
            renderTableBody();
            console.log(`需求 ID: ${currentViewId} 已选中竞标者: ${bid.store_id}`);
        }
    }

    function downloadBids(id) {
        alert('下载所有投标者提交的商品信息功能待实现');
    }

    function closeLogsModal() {
        document.getElementById('logs-dialog').style.display = 'none';
    }

    // 初始化页面
    window.onload = () => {
        w3.includeHTML(() => {
            initDemandsPage();
            document.getElementById('create-demand-dialog').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeCreateDemandModal();
            });
            document.getElementById('view-demand-dialog').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeViewDemandModal();
            });
            document.getElementById('bid-detail-dialog').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeBidDetailModal();
            });
            document.getElementById('logs-dialog').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeLogsModal();
            });
        });
    };
</script>
</body>
</html>