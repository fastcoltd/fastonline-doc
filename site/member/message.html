<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>我的消息 - FASTRESP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="../_site.css">
    <link rel="stylesheet" href="_member.css">
    <link rel="stylesheet" href="_ticket.css">
    <style>
        .message-wrapper { display: flex; flex: 1; width: 100%; padding: 0.5em 0; }
        .message-sidebar { width: 20em; background: var(--bg-white); border-right: 0.0625em solid var(--border-color); padding: 0.5em 0.5em 0.5em 0; height: calc(100vh - 14em); display: flex; flex-direction: column; }
        .message-content { flex: 1; padding: 1em; background: var(--bg-white); max-height: calc(100vh - 14em); overflow-y: auto; }
        .message-tabs { display: flex; gap: 0.5em; margin-bottom: 1em;text-wrap: nowrap;}
        .message-tab { padding: 0.5em; cursor: pointer; border-bottom: 0.125em solid transparent; }
        .message-tab.active { border-bottom: 0.125em solid var(--natural-green); color: var(--natural-green); font-weight: bold; }
        .message-list { flex: 1; overflow-y: auto; overflow-x: hidden; position: relative; }
        .message-item { padding: 0.55em; border-bottom: 0.0625em solid var(--border-color); cursor: pointer; position: relative; display: flex; align-items: center; gap: 0.5em; }
        .message-item:hover { background: var(--bg-light); }
        .message-item.active { background: var(--natural-green); color: var(--font-white); }
        .message-item-content { flex: 1; max-width: calc(100% - 3em); }
        .message-title { font-size: var(--font-medium); margin-bottom: 0.25em; display: flex; justify-content: space-between; }
        .message-text { font-size: var(--font-small); color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .message-badge { position: absolute; top: 1.5em; right: 0.5em; background: var(--vibrant-red); color: var(--font-white); border-radius: 50%; width: 1.5em; height: 1.5em; line-height: 1.5em; text-align: center; font-size: var(--font-small); }
        .message-red-dot { position: absolute; top: 2em; right: 1em; background: var(--vibrant-red); width: 0.75em; height: 0.75em; border-radius: 50%; }
        .message-loading { text-align: center; padding: 1em; color: var(--text-secondary); display: none; }
        .message-details { display: flex; flex-direction: column; height: 100%; }
        .chat-dialog { flex: 1; display: flex; flex-direction: column; background: var(--bg-white); border-radius: 0.5em; overflow: hidden; }
        .chat-dialog-header { padding: 0.75em 1em; border-bottom: 0.0625em solid var(--border-color); background: var(--bg-light); display: flex; align-items: center; gap:1em;position: relative; }
        .chat-dialog-header h3{font-weight: bold;}
        .chat-dialog-header button{display:flex;position: absolute; right: 1em;top: 1em;}
        .chat-dialog-body { flex: 1; padding: 0 0 1em 0; overflow-y: auto; display: flex; flex-direction: column; gap: 1em; }
        .chat-dialog-footer { padding: 1em; border-top: 0.0625em solid var(--border-color); display: flex; flex-direction: column; gap: 0.5em; }
        .chat-message { display: flex; gap: 0.5em; align-items: center; }
        .chat-message.self { flex-direction: row-reverse; }
        .chat-user { display: flex; align-items: center; gap: 0.25em; }
        .chat-buyer { color: var(--natural-green); }
        .chat-seller { color: var(--vibrant-orange); }
        .chat-support { color: var(--vibrant-red); }
        .chat-content { background: var(--bg-chat); padding: 0.5em 1em; border-radius: 0.5em; max-width: 70%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .chat-content::before {right: -1em; border-left-color: var(--bg-chat);}
        .chat-content.self { background: var(--natural-green); color: var(--font-white); }
        .chat-time { font-size: var(--font-small); color: var(--text-secondary); margin-top: 0.25em; }
        .search-box { width: 100%; margin: 0.5em 0.5em 0.5em 0; }
        .search-wrapper { width: calc(100% - 4em); }
        .chat-input { flex: 1; padding: 0.5em; border: 0.0625em solid var(--border-color); border-radius: 0.25em; resize: none; }
        .system-content { font-size: var(--font-medium); line-height: 1.8; padding: 1em; }
        .system-content img { max-width: 100%; border-radius: 0.5em; margin: 1em 0; }
        .system-title { font-size: var(--font-large); font-weight: bold; margin-bottom: 1em; color: var(--text-primary); padding: 0 1em; }
        .system-signature { text-align: right; font-size: var(--font-small); color: var(--text-secondary); margin-top: 1em; padding: 0 1em; }
        .avatar-container { position: relative; width: 2em; height: 2em; }
        .avatar { width: 100%; height: 100%; border-radius: 50%; }
        .status-dot { width: 0.75em; height: 0.75em; border-radius: 50%; position: absolute; right: 0; bottom: 0; border: 0.0625em solid var(--bg-white); }
        .status-dot.online { background: var(--natural-green); }
        .status-dot.offline { background: var(--text-secondary); }
        /* 工单样式 */
        .ticket-chat-container { flex: 1; overflow-y: auto; padding: 1em; }
        .ticket-chat-message { margin-bottom: 1em; display: flex; align-items: flex-start; }
        .ticket-chat-message.system-message { justify-content: center; color: #FF4500; font-weight: bold; text-align: center; }
        .ticket-chat-message .avatar-name { display: flex; flex-direction: column; align-items: center; gap: 0.25em; width: 2em; }
        .ticket-chat-message .avatar-container { width: 3em; height: 3em; }
        .ticket-chat-message .chat-name { font-weight: bold; max-width: 4em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .ticket-chat-message.support-message .chat-name { max-width: 4em; }
        .ticket-chat-message.system-message .chat-name { display: none; }
        .ticket-chat-message .chat-content { display: flex; flex-direction: column; }
        .ticket-chat-message.buyer-message .chat-bubble { background: var(--bg-light); color: var(--font-green);}
        .ticket-chat-message.store-message .chat-bubble { background: #E0E0E0; color: var(--text-primary); }
        .ticket-chat-message.support-message .chat-bubble { background: var(--bg-chat); color: var(--font-red); }
        .ticket-chat-message.system-message .chat-bubble { background: none; padding: 0; white-space: normal; word-wrap: break-word; }
        .ticket-chat-message .chat-bubble { padding: 0.5em 1em; border-radius: 0.375em; white-space: normal; word-wrap: break-word; position: relative; margin: 0 1em; }
        .ticket-chat-message.buyer-message { flex-direction: row-reverse; }
        .ticket-chat-message:not(.system-message) .chat-bubble::before { content: ''; position: absolute; top: 0.5em; width: 0; height: 0; border: 0.5em solid transparent; }
        .ticket-chat-message.buyer-message .chat-bubble::before { right: -1em; border-left-color: var(--bg-light); }
        .ticket-chat-message.store-message .chat-bubble::before { left: -1em; border-right-color: #E0E0E0; }
        .ticket-chat-message.support-message .chat-bubble::before { left: -1em; border-right-color: var(--bg-chat); }
        .ticket-chat-message .request-refund { color: #FF4500; }
        .ticket-chat-message .request-exchange { color: #1E90FF; }
        .ticket-chat-message .request-close { color: #FFD700; }
        .ticket-chat-message .request-support { color: #32CD32; }
        .ticket-chat-message .chat-content { background: none;box-shadow: none }
        .ticket-message-controls { display: flex; justify-content: space-between; align-items: center; gap: 1em; padding-bottom: 0.5em; }
        .ticket-message-tabs { display: flex; gap: 0.5em; }
        .ticket-message-tabs .tab { padding: 0.5em 1em; border: 0.0625em solid var(--border-color); border-radius: 0.375em; cursor: pointer; background: var(--bg-light); }
        .ticket-message-tabs .tab.active { background: var(--natural-green); color: var(--font-white); }
        .ticket-template-buttons { display: flex; gap: 0.5em; flex-wrap: wrap; }
        .ticket-template-buttons .refund-btn { background: #FF4500; color: var(--font-white); }
        .ticket-template-buttons .exchange-btn { background: #1E90FF; color: var(--font-white); }
        .ticket-template-buttons .support-btn { background: #32CD32; color: var(--font-white); }
        .ticket-input-content { display: none; }
        .ticket-input-content.active { display: flex; gap: 0.5em; }
        .ticket-input-content.text-input { flex-direction: row; align-items: stretch; }
        .ticket-input-content textarea { padding: 0.5em; border: none; border-radius: 0.375em 0 0 0.375em; min-height: 4em; resize: vertical; flex: 1; margin: 0; }
        .ticket-input-content .send-btn { width: 10%; height: auto; padding: 0; border-radius: 0 0.375em 0.375em 0; display: flex; align-items: center; justify-content: center; margin: 0; }
        .ticket-template-actions { margin-top: 0.5em; display: flex; gap: 0.5em; }
        .ticket-response-status { margin-top: 0.5em; font-weight: bold; }
        .ticket-timestamp { color: var(--text-secondary); margin-left: 0.5em; font-size: small; text-shadow: 1px 1px 2px var(--font-green); }
        .close-ticket-btn { background: #FF4500; color: var(--font-white); border: none; padding: 0.25em 0.5em; border-radius: 0.375em; cursor: pointer; }
        .close-ticket-btn:hover { background: #D63B00; }
        @media (max-width: 48em) {
            .message-wrapper { flex-direction: column; }
            .message-sidebar { width: 100%; border-right: none; border-bottom: 0.0625em solid var(--border-color); height: auto; }
            .message-content { padding: 0.5em; max-height: none; }
            .message-list { max-height: 20em; }
            .ticket-message-controls { flex-direction: column; align-items: flex-start; }
            .ticket-template-buttons { flex-direction: column; }
            .ticket-input-content.text-input { flex-direction: column; }
            .ticket-input-content textarea { border-radius: 0.375em; margin-bottom: 0.5em; }
            .ticket-input-content .send-btn { width: 100%; height: auto; border-radius: 0.375em; }
        }
    </style>
</head>
<body>
<div w3-include-html="../_header.html"></div>
<div class="member-wrapper">
    <div w3-include-html="_sidebar.html"></div>
    <div class="member-container">
        <div class="member-section">
            <div class="message-wrapper">
                <div class="message-sidebar">
                    <div class="message-tabs" id="message-tabs">
                        <div class="message-tab active" data-tab="chat">聊天(100)</div>
                        <div class="message-tab" data-tab="ticket">工单(66)</div>
                        <div class="message-tab" data-tab="system">系统(10)</div>
                    </div>
                    <form action="#" onsubmit="searchMessages(event)">
                        <div class="search-box">
                            <div class="search-wrapper">
                                <input type="text" id="message-search" placeholder="搜索消息...">
                            </div>
                            <button><i class="fas fa-search"></i></button>
                        </div>
                    </form>
                    <div class="message-list" id="message-list">
                        <div class="message-loading" id="message-loading">Loading next page...</div>
                    </div>
                </div>
                <div class="message-content" id="message-content"></div>
            </div>
        </div>
    </div>
</div>
<div w3-include-html="../_footer.html"></div>
<script src="https://www.w3schools.com/lib/w3.js"></script>
<script src="https://cdn.jsdelivr.net/npm/faker@5.5.3/dist/faker.min.js"></script>
<script src="../_common.js"></script>
<script src="../_member.js"></script>
<script src="_mCommon.js"></script>
<script src="../_fields.js"></script>
<script src="../_data.js"></script>
<script src="_ticket.js"></script>
<script>
    (function() {
        const MESSAGE_TYPES = ['chat', 'ticket', 'system'];
        const MESSAGES_PER_PAGE = 20;
        let currentTab = 'chat';
        let currentPage = 1;
        let selectedMessageId = null;

        const userOrdersFieldConfig = {
            id: { ...ordersFieldConfig.id, label: '订单ID', format: v => v, sample: () => faker.datatype.number({ min: 100000, max: 999999 }) },
            brandName: { label: '品牌', format: v => `<span style="color: ${hotBrands.find(b => b.name === v)?.themeColor || '#000'}">${hotBrands.find(b => b.name === v)?.name || v || '无'}</span> - ${services[Math.floor(Math.random() * services.length)].name}`, sample: () => hotBrands[Math.floor(Math.random() * hotBrands.length)].name },
            itemName: { label: '名称', format: (v, item) => {
                    let randomItem = [
                        (item) => { item.item_id = faker.datatype.number({ min: 100000, max: 999999 }) },
                        (item) => { item.demand_id = faker.datatype.number({ min: 100000, max: 999999 }) },
                        (item) => { item.posts_id = faker.datatype.number({ min: 100000, max: 999999 }) },
                    ];
                    let randomName = faker.commerce.productName();
                    randomItem[randomInt(0, randomItem.length - 1)](item);
                    let name = item.demand_id ? `<i class="fa fa-list"></i> ${randomName}` : item.item_id ? `<i class="fa fa-shopping-cart"></i> ${randomName}` : item.posts_id ? `<i class="fa fa-book"></i> ${randomName}` : '未知';
                    const url = item.demand_id ? `/site/demand.html?name=${randomName}` : item.item_id ? `/site/item.html?name=${randomName}` : item.posts_id ? `/site/post.html?name=${randomName}` : '#';
                    return `<a href="${url}" class="item-name">${name}</a>`;
                }, sample: () => ({}) },
            quantity: { ...ordersFieldConfig.quantity, format: v => v, sample: () => faker.datatype.number({ min: 1, max: 1000 }) },
            coupon: { ...ordersFieldConfig.coupon, format: v => `${v}` },
            amount: { ...ordersFieldConfig.amount, label: '金额', format: v => `<span style="color:var(--font-orange)">${v}</span>`, sample: () => faker.commerce.price(50, 2000, 2, "$") },
            paid_time: { ...ordersFieldConfig.paid_time, label: '时间', sample: () => faker.date.recent().toLocaleString() },
            feedback: { label: '反馈', format: (v, item) => {
                    let actions = '';
                    const hasTicketRedDot = Math.random() > 0.6 && !redDotState.ticket[item.id.sample];
                    const hasCommentRedDot = Math.random() > 0.8 && !redDotState.comment[item.id.sample];
                    actions += Math.random() > 0.5 ? `` : `
                    <button class="btn-small" style="color: ${randomInt(0, 1) > 0 ? '' : 'red'}" onclick="raiseTicket(${item.id.sample}); removeRedDot(this,${item.id.sample}, 'ticket')" title="Ticket">
                        <i class="${randomInt(0, 1) > 0 ? 'far' : 'fa'} fa-paper-plane"></i>
                        ${hasTicketRedDot ? '<span class="red-dot"></span>' : ''}
                    </button>`;
                    actions += Math.random() > 0.5 ? `` : `
                    <button class="btn-small" style="color: ${randomInt(0, 1) > 0 ? 'var(--font-orange)' : ''}" onclick="raiseComment(${item.id.sample}); removeRedDot(this,${item.id.sample}, 'comment')" title="Reviews">
                        <i class="${randomInt(0, 1) > 0 ? 'fas' : 'far'} fa-star"></i>
                        ${hasCommentRedDot ? '<span class="red-dot"></span>' : ''}
                    </button>`;
                    actions = actions.length <= 0 ? '--' : actions;
                    return `<div class="operation-area">${actions}</div>`;
                }, sample: () => null },
            operation: { label: '操作', format: (v, item) => {
                    let actions = '';
                    actions += '<button class="btn-small" onclick="viewDetails(' + item.id.sample + ')">view</button>';
                    actions += '<button class="btn-small" onclick="downloadInvoice(' + item.id.sample + ')"><i class="fa fa-download downloading"></i></button>';
                    return `<div class="operation-area">${actions}</div>`;
                }, sample: () => null }
        };

        window.allOrders = generateData(userOrdersFieldConfig, randomInt(50, 500));

        let allMessages = {
            chat: generateChatMessages(randomInt(20, 99)),
            ticket: generateTicketMessages(randomInt(20, 100)),
            system: generateSystemMessages(randomInt(20, 99))
        };
        let filteredMessages = { ...allMessages };

        function formatTime(date) {
            const now = new Date('2025-03-31T00:00:00');
            const diffMs = now - new Date(date);
            const diffMins = Math.floor(diffMs / (1000 * 60));
            if (diffMins === 0) return 'just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            const diffHours = Math.floor(diffMins / 60);
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            const diffDays = Math.floor(diffHours / 24);
            if (diffDays < 3) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            return new Date(date).toLocaleString('zh-CN', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit' }).replace(/(\d+)\/(\d+)/, '$2/$1');
        }

        function randomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function stripHtml(html) {
            const temp = document.createElement('div');
            temp.innerHTML = html;
            return temp.textContent || temp.innerText || '';
        }

        function generateChatMessages(count) {
            return Array(count).fill().map(() => {
                const now = new Date('2025-03-31T00:00:00');
                const past = new Date(now);
                past.setDate(now.getDate() - randomInt(0, 30));
                const messages = Array(randomInt(5, 20)).fill().map(() => {
                    const msgTime = new Date(now);
                    msgTime.setDate(now.getDate() - randomInt(0, 30));
                    return {
                        sender: faker.name.findName(),
                        content: faker.lorem.sentence(),
                        time: msgTime,
                        isSelf: faker.datatype.boolean()
                    };
                });
                const lastMsg = messages[messages.length - 1];
                return {
                    id: faker.datatype.number({ min: 1, max: 10000 }),
                    title: faker.name.findName(),
                    time: past,
                    newCount: randomInt(0, 5),
                    avatar: getPicsumImage(50, 50, `chat-${randomInt(0, 1000)}`),
                    online: faker.datatype.boolean(),
                    lastMessage: `${lastMsg.sender}: ${lastMsg.content.substring(0, 50)}...`,
                    messages: messages
                };
            }).sort((a, b) => new Date(b.time) - new Date(a.time));
        }

        function generateTicketMessages(count) {
            return Array(count).fill().map(() => {
                const order = {};
                const _supportName = supportNames[randomInt(0, shopNames.length -1)];
                const _storeName = shopNames[randomInt(0, shopNames.length -1)];
                Object.keys(userOrdersFieldConfig).forEach(key => {
                    order[key] = userOrdersFieldConfig[key].sample();
                });
                const now = new Date('2025-03-31T00:00:00');
                const past = new Date(now);
                past.setDate(now.getDate() - randomInt(0, 30));
                const messages = Array(randomInt(5, 20)).fill().map(() => {
                    const msgTime = new Date(now);
                    msgTime.setDate(now.getDate() - randomInt(0, 30));
                    const sender = faker.random.arrayElement(['买家', '卖家', '客服']);
                    const isTemplate = randomInt(0, 2) === 0;
                    const content = isTemplate ? generateTemplateMessage(sender, order.id) : faker.lorem.sentence();
                    return {
                        sender: sender,
                        name: sender === '买家' ? 'Me' : sender === '卖家' ? _storeName : _supportName,
                        content: content,
                        time: msgTime,
                        isSelf: sender === '买家',
                        isTemplate: isTemplate
                    };
                });
                const lastMsg = messages[messages.length - 1];
                return {
                    id: faker.datatype.number({ min: 1, max: 10000 }),
                    title: `订单 #${order.id} - ${faker.commerce.productName()}`,
                    time: past,
                    newCount: randomInt(0, 5),
                    orderId: order.id,
                    amount: order.amount,
                    quantity: order.quantity,
                    participants: [
                        { role: '买家', name: 'Me', avatar: getPicsumImage(50, 50, `buyer-${randomInt(0, 1000)}`), online: faker.datatype.boolean() },
                        { role: '卖家', name: _storeName, avatar: getPicsumImage(50, 50, `seller-${randomInt(0, 1000)}`), online: faker.datatype.boolean() },
                        { role: '客服', name: _supportName, avatar: getPicsumImage(50, 50, `support-${randomInt(0, 1000)}`), online: faker.datatype.boolean() }
                    ],
                    lastMessage: stripHtml(`${lastMsg.name}: ${lastMsg.content.substring(0, 50)}...`), // 去除 HTML
                    messages: messages
                };
            }).sort((a, b) => new Date(b.time) - new Date(a.time));
        }

        function generateTemplateMessage(sender, orderId) {
            const templates = [
                `请求退款\n金额: $${faker.commerce.price(10, 500, 2)}\n<div class="ticket-template-actions"><button class="btn-small" onclick="respondToRequest(${orderId}, 'refund', 'agree', '${sender}', this)">同意</button><button class="btn-small" onclick="openRejectDialog(${orderId}, 'refund', '${sender}', this)">拒绝</button></div>`,
                `请求换货\n数量: ${randomInt(1, 5)}\n<div class="ticket-template-actions"><button class="btn-small" onclick="respondToRequest(${orderId}, 'exchange', 'agree', '${sender}', this)">同意</button><button class="btn-small" onclick="openRejectDialog(${orderId}, 'exchange', '${sender}', this)">拒绝</button></div>`,
                `拒绝理由: ${faker.lorem.sentence()}`
            ];
            return templates[randomInt(0, templates.length - 1)];
        }

        function generateSystemMessages(count) {
            return Array(count).fill().map(() => {
                const now = new Date('2025-03-31T00:00:00');
                const past = new Date(now);
                past.setDate(now.getDate() - randomInt(0, 30));
                return {
                    id: faker.datatype.number({ min: 1, max: 10000 }),
                    title: faker.lorem.sentence(5),
                    time: past,
                    unread: faker.datatype.boolean(),
                    content: `<p>${faker.lorem.paragraphs(randomInt(1, 5))}</p>` + (randomInt(0, 1) ? `<img src="${getPicsumImage(300, 200, `system-${randomInt(0, 1000)}`)}" alt="System Image">` : '')
                };
            }).sort((a, b) => new Date(b.time) - new Date(a.time));
        }

        function initMessagePage() {
            if (!document.getElementById('message-tabs')) {
                console.error('消息页面元素未加载完成');
                return;
            }
            const urlParams = new URLSearchParams(window.location.search);
            const tab = urlParams.get('tab');
            const id = urlParams.get('id');
            if (tab && MESSAGE_TYPES.includes(tab)) {
                currentTab = tab;
                if (id) {
                    selectedMessageId = parseInt(id);
                    ensureMessageExists(currentTab, selectedMessageId);
                }
            }
            if (!selectedMessageId) {
                selectedMessageId = filteredMessages[currentTab][0]?.id;
            }
            renderTabs();
            renderMessageList();
            renderMessageDetails();
            updateUrl();
            setupEventListeners();
        }

        function ensureMessageExists(tab, id) {
            if (!filteredMessages[tab].some(msg => msg.id === id)) {
                const newMessage = tab === 'chat' ? generateChatMessages(1)[0] :
                    tab === 'ticket' ? generateTicketMessages(1)[0] :
                        generateSystemMessages(1)[0];
                newMessage.id = id;
                filteredMessages[tab].push(newMessage);
                allMessages[tab].push(newMessage);
                filteredMessages[tab].sort((a, b) => new Date(b.time) - new Date(a.time));
                allMessages[tab].sort((a, b) => new Date(b.time) - new Date(a.time));
            }
        }

        function renderTabs() {
            const tabs = document.getElementById('message-tabs');
            if (!tabs) return;

            // 计算每个 tab 的未读消息总数
            const unreadCounts = {
                chat: allMessages.chat.reduce((sum, msg) => sum + msg.newCount, 0),
                ticket: allMessages.ticket.reduce((sum, msg) => sum + msg.newCount, 0),
                system: allMessages.system.reduce((sum, msg) => sum + (msg.unread ? 1 : 0), 0)
            };

            tabs.innerHTML = MESSAGE_TYPES.map(type => {
                const count = unreadCounts[type];
                const countDisplay = count > 0 ? `(${count})` : '';
                return `
                    <div class="message-tab ${type === currentTab ? 'active' : ''}" data-tab="${type}">
                        ${type === 'chat' ? '聊天' : type === 'ticket' ? '工单' : '系统'}${countDisplay}
                    </div>
                `;
            }).join('');

            // 重新绑定点击事件
            tabs.querySelectorAll('.message-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    currentTab = tab.dataset.tab;
                    currentPage = 1;
                    selectedMessageId = filteredMessages[currentTab][0]?.id;
                    renderTabs();
                    renderMessageList();
                    renderMessageDetails();
                    updateUrl();
                });
            });
        }

        function renderMessageList() {
            const list = document.getElementById('message-list');
            if (!list) return;
            const loading = document.getElementById('message-loading');
            const start = (currentPage - 1) * MESSAGES_PER_PAGE;
            const end = start + MESSAGES_PER_PAGE;
            const messages = filteredMessages[currentTab].slice(0, end);

            list.innerHTML = messages.map(msg => {
                let html = `<div class="message-item ${msg.id === selectedMessageId ? 'active' : ''}" data-id="${msg.id}">`;
                if (currentTab === 'chat') {
                    const lastMsg = msg.messages[msg.messages.length - 1];
                    html += `<div class="avatar-container">`;
                    html += `<img src="${msg.avatar}" class="avatar" alt="${msg.title}">`;
                    html += `<span class="status-dot ${msg.online ? 'online' : 'offline'}"></span>`;
                    html += `</div>`;
                    html += `<div class="message-item-content">`;
                    html += `<div class="message-title">${msg.title} <span>${formatTime(msg.time)}</span></div>`;
                    html += `<div class="message-text">${msg.lastMessage}</div>`;
                    if (msg.newCount > 0) html += `<span class="message-badge">${msg.newCount}</span>`;
                } else if (currentTab === 'ticket') {
                    html += `<div class="message-item-content">`;
                    html += `<div class="message-title">${msg.title}</div>`;
                    html += `<div class="message-text">${msg.lastMessage} ${formatTime(msg.time)}</div>`;
                    html += `<div class="message-time">${msg.participants.map(p => `<span class="${p.role === '买家' ? 'chat-buyer' : p.role === '卖家' ? 'chat-seller' : 'chat-support'}">${p.name}</span>`).join(', ')}</div>`;
                    if (msg.newCount > 0) html += `<span class="message-badge">${msg.newCount}</span>`;
                } else {
                    html += `<div class="message-item-content">`;
                    html += `<div class="message-title">${msg.title}</div>`;
                    html += `<div class="message-text">${formatTime(msg.time)}</div>`;
                    if (msg.unread) html += `<span class="message-red-dot"></span>`;
                }
                html += `</div>`;
                html += `</div>`;
                return html;
            }).join('') + '<div class="message-loading" id="message-loading">Loading next page...</div>';

            list.querySelectorAll('.message-item').forEach(item => {
                item.addEventListener('click', () => {
                    selectedMessageId = parseInt(item.dataset.id);
                    const msg = filteredMessages[currentTab].find(m => m.id === selectedMessageId);
                    if (msg) {
                        if (currentTab === 'system') {
                            msg.unread = false; // 系统消息标记为已读
                        } else if (msg.newCount > 0) {
                            msg.newCount = 0; // 聊天或工单未读数清零
                        }
                    }
                    renderTabs(); // 更新 tab 的数字
                    renderMessageList();
                    renderMessageDetails();
                    updateUrl();
                });
            });

            const newLoading = list.querySelector('#message-loading');
            newLoading.style.display = end < filteredMessages[currentTab].length ? 'block' : 'none';
        }

        function renderMessageDetails() {
            const content = document.getElementById('message-content');
            if (!content) return;
            const selectedMessage = filteredMessages[currentTab].find(m => m.id === selectedMessageId) || filteredMessages[currentTab][0];
            if (!selectedMessage) {
                content.innerHTML = `<div class="message-details"><div class="message-tips">暂无消息</div></div>`;
                return;
            }

            let html = '<div class="message-details">';
            if (currentTab === 'chat') {
                html += `<div class="chat-dialog">`;
                html += `<div class="chat-dialog-header">`;
                html += `<div class="avatar-container">`;
                html += `<img src="${selectedMessage.avatar}" class="avatar" alt="${selectedMessage.title}">`;
                html += `<span class="status-dot ${selectedMessage.online ? 'online' : 'offline'}"></span>`;
                html += `</div>`;
                html += `<h3>${selectedMessage.title} | 消息保留7天</h3>`;
                html += `</div>`;
                html += `<div class="chat-dialog-body">`;
                html += selectedMessage.messages.map(msg => `
                    <div class="chat-message ${msg.isSelf ? 'self' : ''}">
                        <div class="avatar-container">
                            <img src="${selectedMessage.avatar}" class="avatar" alt="${msg.sender}">
                            <span class="status-dot ${selectedMessage.online ? 'online' : 'offline'}"></span>
                        </div>
                        <div class="chat-content ${msg.isSelf ? 'self' : ''}">${msg.content}</div>
                        <div class="chat-time">${formatTime(msg.time)}</div>
                    </div>
                `).join('');
                html += `</div>`;
                html += `<div class="chat-dialog-footer" style="flex-direction: row;"><textarea class="chat-input" placeholder="输入消息..."></textarea><button class="btn-solid-small" style="width: 10%;" onclick="sendChatMessage(${selectedMessage.id})">发送</button></div>`;
                html += `</div>`;
            } else if (currentTab === 'ticket') {
                const showCloseTicket = Math.random() < 0.5;
                html += `<div class="chat-dialog" id="ticket-chat-dialog-${selectedMessage.id}">`;
                html += `<div class="chat-dialog-header">`;
                html += `<h3>工单 - 订单 #${selectedMessage.orderId} 金额: ${selectedMessage.amount} 数量: ${selectedMessage.quantity} 订单时间: ${formatTime(selectedMessage.time)}</h3>`;
                html += `<div>`;
                html += `${showCloseTicket ? `<button class="btn-small close-ticket-btn" onclick="openCloseTicketConfirmation(${selectedMessage.orderId})">关闭工单</button>` : ''}`;
                html += `</div>`;
                html += `</div>`;
                html += `<div class="chat-dialog-body">`;
                html += `<div class="ticket-chat-container">`;
                html += selectedMessage.messages.map(msg => {
                    const role = msg.sender === '买家' ? 'buyer' : msg.sender === '卖家' ? 'store' : 'support';
                    const nameColor = role === 'buyer' ? '#4CAF50' : role === 'store' ? 'var(--font-orange)' : 'var(--font-red)';
                    return `
                        <div class="ticket-chat-message ${role}-message">
                            <div class="avatar-name" title="${msg.name}">
                                <div class="avatar-container">
                                    <img src="${selectedMessage.participants.find(p => p.role === msg.sender)?.avatar}" class="avatar" alt="${msg.name}">
                                    <span class="status-dot ${selectedMessage.participants.find(p => p.role === msg.sender)?.online ? 'online' : 'offline'}"></span>
                                </div>
                                <span class="chat-name" style="color: ${nameColor}">${msg.name}</span>
                            </div>
                            <div class="chat-content">
                                <div class="chat-bubble">${msg.content}</div>
                            </div>
                        </div>
                    `;
                }).join('');
                html += `</div>`;
                html += `</div>`;
                html += `<div class="chat-dialog-footer">`;
                html += `<div class="ticket-message-controls">`;
                html += `<div class="ticket-message-tabs">`;
                html += `<div class="tab active" data-type="text" onclick="switchTab('text', ${selectedMessage.id})">文本</div>`;
                html += `<div class="tab" data-type="image" onclick="switchTab('image', ${selectedMessage.id})">图片</div>`;
                html += `<div class="tab" data-type="file" onclick="switchTab('file', ${selectedMessage.id})">文件</div>`;
                html += `</div>`;
                html += `<div class="ticket-template-buttons">`;
                html += `<button class="btn-small refund-btn" onclick="openRequestDialog(${selectedMessage.orderId}, 'refund')">申请退款</button>`;
                html += `<button class="btn-small exchange-btn" onclick="openRequestDialog(${selectedMessage.orderId}, 'exchange')">申请换货</button>`;
                html += `<button class="btn-small support-btn" onclick="requestSupport(${selectedMessage.orderId})">申请客服介入</button>`;
                html += `</div>`;
                html += `</div>`;
                html += `<div class="ticket-input-content active" id="text-input-${selectedMessage.id}">`;
                html += `<textarea id="chat-text-input-${selectedMessage.id}" placeholder="请输入消息..."></textarea>`;
                html += `<button class="btn-orange-solid-small send-btn" onclick="sendTicketMessage(${selectedMessage.id}, 'text')">发送</button>`;
                html += `</div>`;
                html += `<div class="ticket-input-content" id="image-input-${selectedMessage.id}">`;
                html += `<input type="file" id="chat-image-input-${selectedMessage.id}" accept="image/*" onchange="previewImage(${selectedMessage.id})" style="display: none;">`;
                html += `<div id="image-preview-${selectedMessage.id}" onclick="document.getElementById('chat-image-input-${selectedMessage.id}').click()">点击选择图片</div>`;
                html += `<button class="btn-orange-solid-small send-btn" onclick="sendTicketMessage(${selectedMessage.id}, 'image')">发送</button>`;
                html += `</div>`;
                html += `<div class="ticket-input-content" id="file-input-${selectedMessage.id}">`;
                html += `<input type="file" id="chat-file-input-${selectedMessage.id}" accept=".txt,.xls,.xlsx" onchange="previewFile(${selectedMessage.id})" style="display: none;">`;
                html += `<div id="file-preview-${selectedMessage.id}" onclick="document.getElementById('chat-file-input-${selectedMessage.id}').click()">点击选择文件</div>`;
                html += `<button class="btn-orange-solid-small send-btn" onclick="sendTicketMessage(${selectedMessage.id}, 'file')">发送</button>`;
                html += `</div>`;
                html += `</div>`;
                html += `</div>`;
            } else if (currentTab === 'system') {
                html += `<div class="chat-dialog">`;
                html += `<div class="chat-dialog-header">`;
                html += `<h3>${selectedMessage.title}</h3>`;
                html += `</div>`;
                html += `<div class="system-content">${selectedMessage.content}`;
                html += `<div class="system-signature">FASTRESP Team<br>${formatTime(selectedMessage.time)}</div>`;
                html += `</div>`;
                html += `</div>`;
            }
            html += `</div>`;
            content.innerHTML = html;

            const chatBody = content.querySelector('.chat-dialog-body');
            if (chatBody) chatBody.scrollTop = chatBody.scrollHeight;
        }

        function switchTab(type, messageId) {
            const tabs = document.querySelectorAll(`.ticket-message-tabs .tab`);
            const contents = document.querySelectorAll(`.ticket-input-content`);
            tabs.forEach(tab => tab.classList.remove('active'));
            contents.forEach(content => content.classList.remove('active'));
            document.querySelector(`.tab[data-type="${type}"]`).classList.add('active');
            document.getElementById(`${type}-input-${messageId}`).classList.add('active');
        }

        function previewImage(messageId) {
            const fileInput = document.getElementById(`chat-image-input-${messageId}`);
            const preview = document.getElementById(`image-preview-${messageId}`);
            const file = fileInput.files[0];
            if (file) {
                if (file.size > 1024 * 1024) {
                    alert('图片大小不能超过1MB');
                    fileInput.value = '';
                    return;
                }
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.innerHTML = `<img src="${e.target.result}" alt="预览" style="max-height: 100%;">`;
                    preview.onclick = null;
                };
                reader.readAsDataURL(file);
            }
        }

        function previewFile(messageId) {
            const fileInput = document.getElementById(`chat-file-input-${messageId}`);
            const preview = document.getElementById(`file-preview-${messageId}`);
            const file = fileInput.files[0];
            if (file) {
                if (file.size > 1024 * 1024) {
                    alert('文件大小不能超过1MB');
                    fileInput.value = '';
                    return;
                }
                preview.innerHTML = `<span>${file.name}</span>`;
                preview.onclick = null;
            }
        }

        function sendTicketMessage(messageId, type) {
            const msg = filteredMessages[currentTab].find(m => m.id === messageId);
            if (!msg) return;
            const chatContainer = document.querySelector('.ticket-chat-container');
            const timestamp = formatTime(new Date());
            let content = '';
            switch (type) {
                case 'text':
                    let maxLine = 10, maxSize = 300;
                    content = document.getElementById(`chat-text-input-${messageId}`).value.trim();
                    let lines = content.split("\n");
                    if (lines.length > maxLine) {
                        alert(`内容不得超过 ${maxLine} 行`);
                        return;
                    }
                    if (content.length > maxSize) {
                        alert(`内容长度不得超过 ${maxSize}`);
                        return;
                    }
                    content = content.replaceAll("\n", "<br/>");
                    if (!content) return;
                    break;
                case 'image':
                    const imageInput = document.getElementById(`chat-image-input-${messageId}`);
                    if (!imageInput.files[0]) return;
                    content = `<img src="${URL.createObjectURL(imageInput.files[0])}" alt="用户上传图片" style="max-width: 200px;">`;
                    imageInput.value = '';
                    document.getElementById(`image-preview-${messageId}`).innerHTML = '点击选择图片';
                    document.getElementById(`image-preview-${messageId}`).onclick = () => document.getElementById(`chat-image-input-${messageId}`).click();
                    break;
                case 'file':
                    const fileInput = document.getElementById(`chat-file-input-${messageId}`);
                    if (!fileInput.files[0]) return;
                    const fileUrl = URL.createObjectURL(fileInput.files[0]);
                    content = `<a href="${fileUrl}" target="_blank" class="download-link">文件: ${fileInput.files[0].name} (${randomInt(1,500)}) <i class="fa fa-download downloading"></i></a>`;
                    fileInput.value = '';
                    document.getElementById(`file-preview-${messageId}`).innerHTML = '点击选择文件';
                    document.getElementById(`file-preview-${messageId}`).onclick = () => document.getElementById(`chat-file-input-${messageId}`).click();
                    break;
            }

            content += ` <span class="ticket-timestamp">${timestamp}</span>`;
            chatContainer.innerHTML += `
                <div class="ticket-chat-message buyer-message">
                    <div class="avatar-name">
                        <div class="avatar-container">
                            <img src="${msg.participants.find(p => p.role === '买家')?.avatar}" class="avatar" alt="我">
                            <span class="status-dot ${msg.participants.find(p => p.role === '买家')?.online ? 'online' : 'offline'}"></span>
                        </div>
                        <span class="chat-name" style="color: #4CAF50">我</span>
                    </div>
                    <div class="chat-content">
                        <div class="chat-bubble">${content}</div>
                    </div>
                </div>
            `;
            if (type === 'text') document.getElementById(`chat-text-input-${messageId}`).value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;

            msg.messages.push({
                sender: '买家',
                name: '我',
                content: content,
                time: new Date(),
                isSelf: true,
                isTemplate: false
            });
            msg.lastMessage = stripHtml(`我: ${content.substring(0, 50)}...`);
            renderMessageList();
        }

        function sendChatMessage(messageId) {
            const input = document.querySelector('.chat-input');
            const content = input.value.trim();
            if (content) {
                const msg = filteredMessages[currentTab].find(m => m.id === messageId);
                if (msg) {
                    msg.messages.push({
                        sender: '我',
                        content: content,
                        time: new Date('2025-03-31T00:00:00'),
                        isSelf: true
                    });
                    msg.lastMessage = `我: ${content.substring(0, 50)}...`;
                    input.value = '';
                    renderMessageList();
                    renderMessageDetails();
                    updateUrl();
                }
            }
        }

        function updateUrl() {
            if (selectedMessageId) {
                const url = `/site/member/message.html?tab=${currentTab}&id=${selectedMessageId}`;
                window.history.pushState({}, document.title, url);
            }
        }

        function searchMessages(event) {
            event.preventDefault();
            const search = document.getElementById('message-search').value.toLowerCase();
            filteredMessages[currentTab] = allMessages[currentTab].filter(msg =>
                msg.title.toLowerCase().includes(search) ||
                (msg.lastMessage && msg.lastMessage.toLowerCase().includes(search))
            );
            currentPage = 1;
            selectedMessageId = filteredMessages[currentTab][0]?.id;
            renderMessageList();
            renderMessageDetails();
            updateUrl();
        }

        function setupEventListeners() {
            const list = document.getElementById('message-list');
            if (!list) return;
            list.addEventListener('scroll', () => {
                const loading = document.getElementById('message-loading');
                const totalMessages = filteredMessages[currentTab].length;
                const loadedMessages = currentPage * MESSAGES_PER_PAGE;

                if (list.scrollTop + list.clientHeight >= list.scrollHeight - 10) {
                    if (loadedMessages < totalMessages) {
                        loading.style.display = 'block';
                        setTimeout(() => {
                            currentPage++;
                            renderMessageList();
                            loading.style.display = loadedMessages + MESSAGES_PER_PAGE < totalMessages ? 'block' : 'none';
                        }, 500);
                    } else {
                        loading.style.display = 'none';
                    }
                } else {
                    loading.style.display = 'none';
                }
            });
        }

        window.onload = () => {
            w3.includeHTML(() => {
                initMessagePage();
            });
        };
    })();
</script>
</body>
</html>